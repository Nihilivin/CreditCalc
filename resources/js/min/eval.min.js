/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
const LINES_MAX_COUNT=15;var crossPageData={};!function(){"use strict";var e=window,t=document,a=new HashHandler;a.registerProperties({amount:1,duration:1,rate:1,payment:1,paymentYear:1,paymentTotal:1,wasCalc:["amount","duration","rate","payment"],graph_1_mode:["m","y"]}),e.hashHandler=a;var n,o,r={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},i=new Calculator,s={},l={amount:0,duration:1,rate:2,payment:3},u={y:[],m:[]},c=gei("graph_1-body_scroll"),d=gei("graph_1-body_scroll-container-years"),h=gei("graph_1-body_scroll-container-months"),p=qs(".html-prototype",c),m=t.createElement("div"),f=gei("graph_1"),g="y",y=geiN("graph_1-scroll_area"),v=gei("graph_1-body_scroll-container");e.formElems=s,l=Object.keys(l),window.calculator=i,p.classList.remove("html-prototype"),m.appendChild(p),n=m.innerHTML,on(window,"load",function(){function p(e){return parseFloat(String(e).replace(/ /g,"").replace(/,/g,".")||0)}function m(e,t){return t=p(t),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*t).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(t).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*t).toFixed(0))/100).toFixed(2):void 0}function M(e){e+="";var t,a=e.match(/^(\d*)(?:[.,](\d*))?$/),n=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(isNA(a)||0===a.length)return"";for(;a[1].match(n);)a[1]=a[1].replace(n,"$1 $2");if(t=a[1],!isNA(a[2])){for(t+=",";a[2].match(o);)a[2]=a[2].replace(o,"$1 $2");t+=a[2]}return t}function _(e){return e.length>0?!(e.match(/[^0-9,. ]/)||(e.match(/[.,]/g)||[]).length>1||!e.match(/^\d/)||!e.match(/\d$/)):!1}function x(){var e,t=function(t){return t!==e&&_(s[t].value.value)};for(e in s)hop(s,e)&&(s[e].padlock.disabled=!_(s[e].value.value),s[e].calc.disabled=3!==Object.keys(s).filter(t).length)}function L(e){return s[e]&&s[e].value?(s[e].value.classList.remove("calculated"),p(s[e].value.value)):0}function b(e){for(var t=e.amount,a=1,n=[],o=181;Math.round(100*t)>0&&o>a;){var r=e.amount,i=e.paymentTotal-e.amount,s=e.payment,l=e.rate,u=l/1200,c=u+1,d=-s,h=d/(1-c),p=Math.pow(c,a)*(r-h)+h,m=Math.pow(c,a)*(i-h)+h;a++;var f={interests:t*u,loan:s-t*u,loanLeft:p,interestsLeft:m};t=p,n.push(f)}return n}function w(e){for(var t=qsa(".graph_1-line.active"),a=0,n=t.length;n>a;a++)t[a].classList.remove("active");if(isNA(e))f.classList.remove("has-active-line"),Z.style.width="0px",Q.style.width="0px",K.style.left="0px",K.style.right="0px",K.firstElementChild.style.width="0px",K.lastElementChild.style.width="0px";else{var o;if(e!==!0){f.classList.add("has-active-line");for(var r=e.target;!r.classList.contains("graph_1-line");)r=r.parentElement;r.classList.add("active");for(var a=0,n=r.parentElement.childNodes.length;n>a&&r.parentElement.childNodes[a]!=r;a++);a--,"m"===g?o=inRange.m[Object.keys(inRange.m)[a]]:"y"===g&&(o=inRange.y[Object.keys(inRange.y)[a]]),$=o}else o=$;if(!o)return;console.info("Displaying infos for:",o);var s=(i.amount-o.loanLeft)/U||0,l=(i.paymentTotal-i.amout-o.interestsLeft)/U||0;Z.style.width=s+"px",Q.style.width=l+"px",K.style.left=W-s+"px",K.style.right=J-l+"px",K.firstElementChild.style.width=s-10+"px",K.lastElementChild.style.width=l-10+"px",X()}}function N(e,t){return e=e.replace(/\{\s*([\w\.]+)\s*\}/g,function(e,a){var n=a.split("."),o=t,r=0,i=n.length;for(r;i>r&&(o="object"==typeof t?o[n[r]]:"",""!==o);r++);return o||""})}function T(e){if(document.createRange){var a,n=t.createRange();return n.selectNode(document.body),a=n.createContextualFragment(e),a.firstChild}var o=t.createElement("div");return o.innerHTML=e,o.firstChild}function C(t){function a(e,t){for(var a=b(e),n=0,o=a.length,r=t.getMonth(),i=t.getFullYear(),s=i,l={};o>n&&i+LINES_MAX_COUNT+1>s;n++){if(isNA(l[s])&&(l[s]={}),l[s][r+1]=a[n],r++,r>11||n===o-1&&!isNA(l[s])){for(var u in l[s])hop(l[s],u)&&(isNA(l[s].loan)&&(l[s].loan=0),l[s].loan+=l[s][u].loan,isNA(l[s].interests)&&(l[s].interests=0),l[s].interests+=l[s][u].interests);l[s].loanLeft=a[n===o-1?n:n-1].loanLeft}r>11&&(r=0,s++)}return l}function o(e,t){t=[].slice.call(t);for(var a=0,n=t.length,o=0;n>o;o++){var r=qs(e,t[o]);r&&(a=Math.max(r.offsetWidth,a))}return a}clearInterval(R);var s=i,l=new Date,l=new Date(l.getFullYear(),l.getMonth()+1),c=new Date(l.getFullYear()+Math.floor(s.duration),l.getMonth()+Math.round(s.duration%1*12)),p=a(s,l),f=l.getFullYear(),g={y:{},m:{}};e.inRange=g;for(var v,_=0;LINES_MAX_COUNT>_&&!isNA(v=p[f+_]);_++)g.y[String(f+_)]={loanLeft:v.loanLeft,loan:v.loan,interests:v.interests};for(var x,L,_=-1,C=l.getMonth()+1,q=0;++_<LINES_MAX_COUNT&&!isNA(x=p[f+q])&&!isNA(L=x[C]);)g.m[r[C]["short"]+" "+(f+q)]={loanLeft:L.loanLeft,loan:L.loan,interests:L.interests},C++,C>12&&(q++,C=1);A(gei("datestart"),r[l.getMonth()+1].full+" "+l.getFullYear(),t),A(gei("dateend"),r[c.getMonth()+1].full+" "+c.getFullYear(),t),A(gei("refund_amount"),M(m("roundMoney",s.paymentTotal)),t),A(gei("payback_amount"),M(m("roundMoney",s.amount)),t),A(gei("interests_amount"),M(m("roundMoney",s.paymentTotal-s.amount)),t);var k,H=Object.keys(g.y),F=H.length,E=Object.keys(g.m),Y=E.length;for(k=0;F>k;k++){var S=H[k],j=g.y[S],D=function(){return S==l.getFullYear()&&S==c.getFullYear()?c.getMonth()-l.getMonth():S==l.getFullYear()?12-l.getMonth():S==c.getFullYear()?c.getMonth()+1:12}()/12;if(isNA(u.y[k])){var I=N(n,{type:"year",label:S,payment:M(m("roundMoney",s.paymentYear*D))+" €",loan_paid:M(m("roundMoney",j.loan))+"€",interests_paid:M(m("roundMoney",j.interests))+"€"}),$=T(I);u.y.push($),d.appendChild($),on($,"click",w),$.classList.add("inside"),k===F-1&&$.classList.add("last")}else u.y[k].classList.add("inside"),k===F-1?u.y[k].classList.add("last"):u.y[k].classList.remove("last"),qsN(".date p",u.y[k]).innerHTML=S,qsN(".payment p",u.y[k]).innerHTML=M(m("roundMoney",s.paymentYear*D))+" €",qsN(".refund p",u.y[k]).innerHTML=M(m("roundMoney",j.loan))+"€",qsN(".interests p",u.y[k]).innerHTML=M(m("roundMoney",j.interests))+"€"}for(;LINES_MAX_COUNT>k;k++){var B=u.y[k];if(isNA(B))break;B.classList.remove("inside"),B.classList.remove("last")}for(k=0;Y>k;k++){var S=E[k],G=g.m[S];if(isNA(u.m[k])){var I=N(n,{type:"month",label:S,payment:M(m("roundMoney",s.payment))+" €",loan_paid:M(m("roundMoney",G.loan))+"€",interests_paid:M(m("roundMoney",G.interests))+"€"}),$=T(I);u.m.push($),h.appendChild($),on($,"click",w),$.classList.add("inside"),k===Y-1&&$.classList.add("last")}else u.m[k].classList.add("inside"),k===Y-1?u.m[k].classList.add("last"):u.m[k].classList.remove("last"),qsN(".date p",u.m[k]).innerHTML=S,qsN(".payment p",u.m[k]).innerHTML=M(m("roundMoney",s.payment))+" €",qsN(".refund p",u.m[k]).innerHTML=M(m("roundMoney",G.loan))+"€",qsN(".interests p",u.m[k]).innerHTML=M(m("roundMoney",G.interests))+"€"}for(;LINES_MAX_COUNT>k;k++){var B=u.m[k];if(isNA(B))break;B.classList.remove("inside"),B.classList.remove("last")}var K=gei("graph_1_head"),Q=K.offsetWidth,Z=0,ee=qs(".line-year .date",d);qs("p",ee);X(),function(){function e(e){z=!0,Q=K.offsetWidth,Z=0;var t,a,n=Q-(l+40);p>=1?(t=Math.max(i,n/(p+1)),a=Math.max(r,Math.min(n-t,n/(p+1)*p))):(a=Math.max(r,n/(p+1)*p),t=Math.max(i,Math.min(n-a,n/(p+1)))),J=t,W=Q-J;var o=1.5*Math.max(u/a,c/t),d=qs(".refund .graph-elem",K),h=qs(".interests .graph-elem",K);U=Math.max(s.amount/W,(s.paymentTotal-s.amount)/J);for(var y=0;Y>y;y++){var v=g.m[E[y]];if(!isNA(v)){var _=f[y],x=qs(".refund .graph-elem",_),L=qs(".interests .graph-elem",_);x.style.width=v.loan/o+"px",L.style.width=v.interests/o+"px"}}o=Math.max(Math.max(g.y[H[Math.max(F-1,0)]].loan,g.y[H[Math.max(F-2,0)]].loan)/a,Math.max(g.y[H[Math.min(F-1,0)]].interests,g.y[H[Math.min(F-1,1)]].interests)/t);for(var y=0;F>y;y++){var v=g.y[H[y]];if(!isNA(v)){var _=m[y],x=qs(".refund .graph-elem",_),L=qs(".interests .graph-elem",_);x.style.width=v.loan/o+"px",L.style.width=v.interests/o+"px"}}w(!0),O.innerHTML=M+"#graph_1 .right{min-width:"+J+"px;max-width:"+J+"px;width:"+J+"px;}\n",d.style.width=s.amount/U+"px",h.style.width=(s.paymentTotal-s.amount)/U+"px",X()}var t=qsa(".graph_1-line",y),a=o(".date",t),n=o(".payment",t),r=o(".refund p",t),i=o(".interests p",t),l=a+n,u=g.m[E[Y-1]].loan,c=g.m[E[0]].interests,p=u/c,m=(s.amount/(s.paymentTotal-s.amount),qsa(".line-year",d)),f=qsa(".line-month",h),v="#graph_1 .graph_1-line ",M=v+".date{width:"+a+"px}\n"+v+".payment{width:"+n+"px}\n"+v+".refund{min-width:"+r+"px;flex:"+p+" 0 0}\n"+v+".interests{min-width:"+i+"px;flex:1 0 0}\n";O.innerHTML=M,V?off(window,"resize",P):V=!0,clearInterval(R),P=e,on(window,"resize",P),go(window,"resize"),setTimeout(function(){X()},100)}()}function A(e,t,a){function n(){var t=o.offsetWidth;e.classList.remove("prepare"),e.classList.add("doing"),e.style.width=t+"px",e.style.height=o.offsetHeight+"px",setTimeout(function(){for(var t=e.firstChild,a=t.nextElementSibling;a;)t=a.nextElementSibling,e.removeChild(a),a=t;e.classList.remove("doing"),e.style.width=""},500)}if(a=a===!0,!isNA(e)){if(a)return void(e.innerHTML="<span>"+t+"</span>");var o=T("<span>"+t+"</span>");e.style.height=e.firstChild.offsetHeight+"px",e.style.width=e.firstChild.offsetWidth+"px",e.classList.add("prepare"),e.insertBefore(o,e.firstChild),waitUntil(n,function(){return 0!==o.offsetWidth||0!=t.length},10,500)}}function q(e){if(H(e),ae!==!1&&1&e.buttons){var t=G.offsetHeight-B.offsetHeight-10,a=Math.min(t,Math.max(0,e.pageY-ae));B.style.top=a+"px",v.style.top="-"+(o[g]-c.offsetHeight)*(a/t)+"px"}}function k(e){off(document,"mouseup",k),ae!==!1&&(H(e),1&e.buttons||(off(t,"mousemove",q),ae=!1))}function H(e){e.stopPropagation(),e.preventDefault()}on(window,["mouseup","mouseleave","blur"],function(){for(var e=0,t=S.length;t>e;e++)go(S[e],"mouseup")});var F,E,Y,O=t.createElement("style"),S=qsa("button.repeatable"),j=function(e){var t,a,n,o=S[e],r=o.getAttribute("data-timer-basestep")||500;on(o,"mousedown",function(){n++,a=r/(Math.log(Math.pow(n,2))+1),t=setTimeout(function(){go(o,"mousedown")},a)}),on(o,["mouseup","mouseleave","blur"],function(){clearTimeout(t),a=r,n=0}),go(o,"mouseup")},D=function(e){var t=l[e];s[t]={calc:gei(t+"-button"),value:gei(t+"-value"),buttonsContainer:gei(t+"-buttons-plus-minus-container"),padlock:gei(t+"-padlock"),plus:gei(t+"-plus"),minus:gei(t+"-minus")},s[t].value.setAttribute("data-placeholder",s[t].value.placeholder),s[t].calculate=function(){var e=l.filter(function(e){return e!==t}),n=t;return function(){w();var t,o,r=i,l=s[n].value;for(t in e)hop(e,t)&&(r[e[t]]=L(e[t]));o=r["calc_"+n](),"payment"===n?r.paymentYear=12*o:r.paymentYear=12*r.payment,r[n]=o,l.value=M(m(n,o)),I=mergeRecursive(I,{amount:parseFloat(m("amount",r.amount)),duration:parseFloat(m("duration",r.duration)),rate:parseFloat(m("rate",r.rate)),payment:parseFloat(m("payment",r.payment)),paymentYear:parseFloat(m("payment",r.paymentYear)),paymentTotal:parseFloat(m("payment",r.paymentTotal)),wasCalc:n}),a.encode(I),l.classList.add("calculated"),x(),C()}}(),on(s[t].calc,"click",s[t].calculate),on([s[t].padlock],"click",function(){var e=s[t].buttonsContainer;return function(){e.classList.toggle("locked"),s[t].value.readOnly=e.classList.contains("locked");var a=2===l.filter(function(e){return s[e].buttonsContainer.classList.contains("locked")}).length;l.forEach(function(e){var t=s[e].buttonsContainer;t.classList.contains("locked")||a!==!0?t.classList.remove("increment"):t.classList.add("increment")})}}()),on([s[t].plus,s[t].minus],"mousedown",function(){var e=s[t].value,a=t;return function(n){var o,r,i,u,c,d;switch(o=n.target.id===a+"-plus"?1:n.target.id===a+"-minus"?-1:0,a){case"duration":u=.001,r=1,i=[1,+(1/0)];break;case"amount":case"payment":for(c=1,d=p(e.value);d>100-o;c*=10)d/=10;u=.001,r=c,i=[0,+(1/0)];break;case"rate":u=.001,r=p(e.value)>10?1:p(e.value)<1-.001*o?.01:.1,i=[0,10]}e.value=M(m(a,Math.max(i[0],Math.min(i[1],p(e.value)+r*o)).toFixed(2)-u)),x(),l.forEach(function(e){e!==t&&s[e].buttonsContainer.classList.contains("increment")&&s[e].calculate()})}}()),on(s[t].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),on(s[t].value,["blur","keyup","change","input"],function(){var e=this,t=e.value.trim();!_(t)&&t.length>0?e.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):e.setCustomValidity(""),x()}),on(s[t].value,"keypress",function(e){String.fromCharCode(e.which||e.keyCode).match(/^[0-9,. ]$/)||e.preventDefault(),13==(e.which||e.keyCode)&&s[t].calculate()}),on(s[t].value,"blur",function(){var e=this;e.placeholder=e.getAttribute("data-placeholder"),_(e.value)?e.value=M(m(t,e.value)):""===e.value?e.setCustomValidity(""):e.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")})},I=a.decode();O.id="dynamicStylesheet",document.head.appendChild(O);var R,U,$,J,W,X=function(){var e=geiN("graph_1-foot"),t=geiN("refund"),a=geiN("graph_1-scroll_cursor"),n=(geiN("graph_1-scroll_line"),geiN("graph_1-scroll_area")),r=qs(".action-buttons"),i=geiN("basic_data"),s=function(){var s=qsN("#graph_1-body_scroll-container-years .graph_1-line.inside"),l=qsN("#graph_1-body_scroll-container-years .graph_1-line.inside.last"),u=qsN("#graph_1-body_scroll-container-months .graph_1-line.inside"),d=qsN("#graph_1-body_scroll-container-months .graph_1-line.inside.last");o={y:l.offsetTop+50-s.offsetTop,m:d.offsetTop+50-u.offsetTop},v.style.top=Math.min(Math.max(-(o[g]-c.offsetHeight),v.style.top.slice(0,-2)),0)+"px",n.style.maxHeight=o[g]+"px";var h=e.offsetTop+e.offsetHeight+40-t.offsetTop+o[g]-n.offsetHeight;f.style.maxHeight=h+"px",setTimeout(function(){var t=Math.min(i.offsetHeight-(n.offsetTop+e.offsetHeight+r.offsetHeight+60),o[g]-10),s=Math.min(n.offsetHeight/o[g]*t,o[g]-10);a.style.height=s+"px";var l=parseFloat(a.style.top.slice(0,-2))||0,u=Math.max(0,Math.min(t-s,l));l!=u&&(a.style.top=u)},100)};return function(){setTimeout(function(){s(),X=function(){s(),setTimeout(s,500)},qs("body").classList.add("ready_graph_1")},500)}}(),V=!1,z=!1,P=null,B=gei("graph_1-scroll_cursor"),G=gei("graph_1-scroll_bar"),K=gei("graph_1-lineinfos"),Q=gei("graph-elem-hover-right"),Z=gei("graph-elem-hover-left");for(F=0,E=S.length;E>F;F++)j(F);for(F in l)hop(l,F)&&D(F);if(0!==Object.keys(I).length&&I.constructor===Object){var ee=["payment","paymentYear","paymentTotal","amount","duration","rate"];for(F in ee){var te=ee[F];isNA(I[te])||(i[te]=I[te],s[te]&&(s[te].value.value=M(m("paymentYear"!=te?te:"payment",I[te]))))}isNA(I.graph_1_mode)||(g=I.graph_1_mode,f.setAttribute("data-display-mode","m"===g?"month":"year"),geiN("toggle-year_month-input").checked="m"===g),4===Object.keys(s).filter(function(e){return _(s[e].value.value)}).length&&(Y=s[I.wasCalc],Y&&Y.value&&Y.value.classList.add("calculated"),C(!0))}x(),on(gei("toggle-year_month-input"),"change",function(){var e=f.getAttribute("data-display-mode");e&&"year"!=e?(f.setAttribute("data-display-mode","year"),I.graph_1_mode=g="y"):(f.setAttribute("data-display-mode","month"),I.graph_1_mode=g="m"),a.encode(I),w(),X()}),e.switchText=A;var ae=!1;on(B,"mousedown",function(e){H(e),1&e.buttons&&(on(t,"mousemove",q),ae=e.pageY-B.offsetTop),on(document,"mouseup",k)}),on(B,"contextmenu",function(e){return H(e),!1})})}();