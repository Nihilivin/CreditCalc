/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
!function(){"use strict";function t(){var t,e,n,a,r=null;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},paymentYear:{get:function(){return r},set:function(t){t=parseFloat(t),console.log(t),isFinite(t)&&t>0&&(r=t)}}})}function e(t){return null===t||"undefined"==typeof t}function n(t,n,a){function r(t,e,n){t&&e&&n&&(t.addEventListener||t.attachEvent).call(t,e,n)}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,l=0,i=0,u=t.length,s=n.length,c=a.length;for(o=0;u>o;o++)for(l=0;s>l;l++)for(i=0;c>i;i++)r(t[o],n[l],a[i])}function a(t,n,a){function r(t,e,n,a){t&&e&&n&&(y.createEvent?(a=new Event(e),t.dispatchEvent(a)):(a=y.createEventObject(),t.fireEvent("on"+e,a)))}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,l=0,i=t.length,u=n.length;for(o=0;i>o;o++)for(l=0;u>l;l++)r(t[o],n[l],a)}function r(t){(e(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var n={};for(var a in t){var r="wasCalc"===a?d[t[a]]:t[a];n[d[a]||a]=r}var o=JSON.stringify(n),l=o.slice(1).slice(0,-1).replace(/"/g,""),i=p.convert(h,l);try{history.pushState?history.pushState(null,null,"#"+i):location.hash="#"+i}catch(u){console.error("Could not change hash:",u)}}function o(){var t,e=location.hash.slice(1),n={};try{t=h.convert(p,e),n=JSON.parse(("{"+t+"}").replace(/(\{|,)([^:]+)|([a-zA-Z]+)/g,'$1"$2$3"'))}catch(a){console.error(a,a.stack)}var r={};for(var o in n){var l="wasCalc"===f.filter(function(t){return d[t]==o})[0]?f.filter(function(t){return d[t]==n[o]})[0]:n[o];r[f.filter(function(t){return d[t]==o})[0]||o]=l}return r}function l(t){return y.getElementById(t)}function i(t){return l(t)||{}}function u(t,e){return(e||y).querySelector(t)}function s(t,e){return(e||y).querySelectorAll(t)}function c(t,e){return t.hasOwnProperty(e)}t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,n,a=this,r=new t,o=0,l=1,i=0;if(a.payment*(12*a.duration)<a.amount)return 0;for(r.duration=a.duration,r.payment=a.payment;l>1e-4&&999>=i;)i++,e=o,o+=l,r.rate=o,n=r.calc_amount(),n<a.amount?(l/=10,o=e):n===a.amout&&(i=1e3);return o},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var d={amount:1,duration:2,rate:3,payment:4,paymentYear:5,wasCalc:9},f=Object.keys(d),h=new Base("!$&'()*+,;=-._~:@/?ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxyz0123456789"),p=new Base(":1234567890,.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),m={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},y=document,v=new t,g={},M={amount:0,duration:1,rate:2,payment:3},b={y:[],m:[]};M=Object.keys(M),function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function d(e,n){return n=t(n),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*n).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(n).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*n).toFixed(0))/100).toFixed(2):void 0}function f(t){t+="";var n,a=t.match(/^(\d*)(?:[.,](\d*))?$/),r=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(e(a)||0===a.length)return"";for(;a[1].match(r);)a[1]=a[1].replace(r,"$1 $2");if(n=a[1],!e(a[2])){for(n+=",";a[2].match(o);)a[2]=a[2].replace(o,"$1 $2");n+=a[2]}return n}function h(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function p(){var t,e=function(e){return e!==t&&h(g[e].value.value)};for(t in g)c(g,t)&&(g[t].padlock.disabled=!h(g[t].value.value),g[t].calc.disabled=3!==Object.keys(g).filter(e).length)}function w(e){return g[e]&&g[e].value?(g[e].value.classList.remove("calculated"),t(g[e].value.value)):0}function F(t,e){var n=y.createElement("table"),a=y.createElement("tbody"),r=t.cloneNode(!0);return n.appendChild(a),r.classList.remove("html-prototype"),a.appendChild(r),a.innerHTML=C(a.innerHTML,e),a.firstChild}function L(t){for(var e,n,a=t.amount,r=a,o=t.payment,l=t.rate,i=l/1200,u=i+1,s=-o,c=s/(1-u),d=1,f=[];Math.round(100*r)>0;)e=Math.pow(u,d)*(a-c)+c,d++,n={interests:r*i,loan:o-r*i,amountAtBegin:r,loanLeft:e},r=e,f.push(n);return f}function C(t,e){return t=t.replace(/\{\s*([\w\.]+)\s*\}/g,function(t,n){var a=n.split("."),r=e,o=0,l=a.length;for(o;l>o&&(r="object"==typeof e?r[a[o]]:"",""!==r);o++);return r||""})}function _(t){if(document.createRange){var e,n=document.createRange();return n.selectNode(document.body),e=n.createContextualFragment(t),e.firstChild}var a=document.createElement("div");return a.innerHTML=t,a.firstChild}function k(){function t(t,n){for(var a=L(t),r=0,o=a.length,l=n.getMonth(),i=n.getFullYear(),u=i,s={};o>r&&i+16>u;r++){if(l++,l>11||r===o-1){for(var c in s[u])s[u].hasOwnProperty(c)&&(e(s[u].loan)&&(s[u].loan=0),s[u].loan+=s[u][c].loan,e(s[u].interests)&&(s[u].interests=0),s[u].interests+=s[u][c].interests);s[u].loanLeft=a[r===o-1?r:r-1].loanLeft}l>11&&(l=0,u++),e(s[u])&&(s[u]={}),s[u][l+1]=a[r]}return s}function n(t,e){e=[].slice.call(e);for(var n=0,a=e.length,r=0;a>r;r++){var o=u(t,e[r]);o&&(n=Math.max(o.offsetWidth,n))}return n}for(var a,r=v,o=new Date,o=new Date(o.getFullYear(),o.getMonth()+1),i=new Date(o.getFullYear()+Math.floor(r.duration),o.getMonth()+Math.round(r.duration%1*12)),c=t(r,o),h=15,p=o.getFullYear(),g={y:{},m:{}},M=0;h>M&&!e(a=c[p+M]);M++)g.y[String(p+M)]={loanLeft:a.loanLeft,loan:a.loan,interests:a.interests};for(var w,F,M=-1,k=o.getMonth(),Y=0;++M<h&&!e(w=c[p+Y])&&!e(F=w[k+1]);)console.log(k,M,F),g.m[M+"_"+m[k+1]["short"]+" "+(p+Y)]={loanLeft:F.loanLeft,loan:F.loan,interests:F.interests},k++,12==k&&(Y++,k=0);console.log(g);var A=l("datestart"),E=l("dateend");A&&(A.innerHTML=m[o.getMonth()+1].full+" "+o.getFullYear()),E&&(E.innerHTML=m[i.getMonth()+1].full+" "+i.getFullYear());var S,x=l("graph_1-body_scroll"),T=u(".html-prototype",x),H=y.createElement("div");T.classList.remove("html-prototype"),H.appendChild(T),S=H.innerHTML;for(var M in g.y){var j=g.y[M],$=function(){return M==o.getFullYear()&&M==i.getFullYear()?i.getMonth()-o.getMonth():M==o.getFullYear()?12-o.getMonth():M==i.getFullYear()?i.getMonth()+1:12}()/12,J=C(S,{type:"year",label:M,payment:f(d("roundMoney",r.paymentYear*$))+" €",loan_paid:f(d("roundMoney",j.loan))+"€",loan_width:d("roundMoney",j.loan)/(12*r.payment)*100+"%",interests_paid:f(d("roundMoney",j.interests))+"€",interests_width:d("roundMoney",j.interests)/(12*r.payment)*100+"%"}),D=_(J);console.log($),b.y.push(D),x.appendChild(D)}var N=s(".line-year",x);setTimeout(function(){var t=n(".date",N),e=n(".payment",N),a=n(".refund p",N),r=n(".interests p",N);console.log(a,r),O.innerHTML=".graph_1-line.line-year .date{width:"+t+"px}.graph_1-line.line-year .payment{width:"+e+"px}"},1e3)}var Y,A,E,O=y.createElement("style"),S=s("button.repeatable"),x=function(t){var e,r,o,l=S[t],i=l.getAttribute("data-timer-basestep")||500;n(l,"mousedown",function(){o++,r=i/(Math.log(Math.pow(o,2))+1),e=setTimeout(function(){a(l,"mousedown")},r)}),n([l,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),r=i,o=0}),a(l,"mouseup")},T=function(e){var a=M[e];g[a]={calc:l(a+"-button"),value:l(a+"-value"),buttonsContainer:l(a+"-buttons-plus-minus-container"),padlock:l(a+"-padlock"),plus:l(a+"-plus"),minus:l(a+"-minus")},g[a].value.setAttribute("data-placeholder",g[a].value.placeholder),g[a].calculate=function(){var t=M.filter(function(t){return t!==a}),e=a;return function(){var n,a,o=v,l=g[e].value;for(n in t)c(t,n)&&(o[t[n]]=w(t[n]));a=o["calc_"+e](),"payment"===e?v.paymentYear=12*a:v.paymentYear=v.payment,v[e]=a,l.value=f(d(e,a)),r({amount:parseFloat(d("amount",o.amount)),duration:parseFloat(d("duration",o.duration)),rate:parseFloat(d("rate",o.rate)),payment:parseFloat(d("payment",o.payment)),paymentYear:parseFloat(d("payment",o.paymentYear)),wasCalc:e}),l.classList.add("calculated"),p(),k()}}(),n(g[a].calc,"click",g[a].calculate),n([g[a].padlock],"click",function(){var t=g[a].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===M.filter(function(t){return g[t].buttonsContainer.classList.contains("locked")}).length;M.forEach(function(t){var n=g[t].buttonsContainer;n.classList.contains("locked")||e!==!0?n.classList.remove("increment"):n.classList.add("increment")})}}()),n([g[a].plus,g[a].minus],"mousedown",function(){var e=g[a].value,n=a;return function(r){var o,l,i,u,s,c;switch(o=r.target.id===n+"-plus"?1:r.target.id===n+"-minus"?-1:0,n){case"duration":u=-.001,l=1,i=[0,+(1/0)];break;case"amount":case"payment":for(s=1,c=t(e.value);c>100-o;s*=10)c/=10;u=.001,l=s,i=[0,+(1/0)];break;case"rate":u=.001,l=t(e.value)>10?1:t(e.value)<1-.001*o?.01:.1,i=[0,10]}e.value=f(d(n,Math.max(i[0],Math.min(i[1],t(e.value)+l*o)).toFixed(2)-u)),p(),M.forEach(function(t){t!==a&&g[t].buttonsContainer.classList.contains("increment")&&g[t].calculate()})}}()),n(g[a].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),n(g[a].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!h(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),p()}),n(g[a].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault()}),n(g[a].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),h(t.value)?t.value=f(d(a,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),n(l("toggle-year_month-input"),"change",function(){function t(){}l("depreciation_schedule"),l("toggle-year_month-input");return t(),t}())},H=o();for(O.id="dynamicStylesheet",u("head").appendChild(O),Y=0,A=S.length;A>Y;Y++)x(Y);for(Y in M)c(M,Y)&&T(Y);if(0!==Object.keys(H).length&&H.constructor===Object){for(Y in H)console.log(Y,M),c(H,Y)&&(v[Y]=H[Y],g[Y]&&(g[Y].value.value=f(d("paymentYear"!=Y?Y:"payment",H[Y]))));E=g[H.wasCalc],4===Object.keys(g).filter(function(t){return h(g[t].value.value)}).length&&(E&&E.value&&E.value.classList.add("calculated"),k())}p(),n([].slice.call(s(".pager-button")),"click",function(){var t=u("body");return function(){if(t.setAttribute("data-page",this.getAttribute("data-page-target")),"pager-button-1_2"===this.id){var n,a,r,o,c,h,p,y,g,M,b,w,C,_,k,Y=v,A=L(Y),E=new Date,S=E.getMonth(),x=E.getFullYear(),T={},H=0,j=A.length,$=E.getFullYear(),J=0,D=0,N={},V=function(t,e,n){var a="yearly"===t?12:1;return F(o,{type:t,label:e,loan_paid:f(d("roundMoney",n.loan))+"€",loan_width:d("roundMoney",n.loan)/(Y.payment*a)*100+"%",interests_paid:f(d("roundMoney",n.interests))+"€",interests_width:d("roundMoney",n.interests)/(Y.payment*a)*100+"%"})};for(console.log(S,x),H;j>H;H++){if(S++,S>11||H===j-1){for(n in T[x])T[x].hasOwnProperty(n)&&(e(T[x].loan)&&(T[x].loan=0),T[x].loan+=T[x][n].loan,e(T[x].interests)&&(T[x].interests=0),T[x].interests+=T[x][n].interests);T[x].loanLeft=A[H===j-1?H:H-1].loanLeft}S>11&&(S=0,x++),null===T[x]&&(T[x]={}),T[x][S+1]=A[H]}for(a=l("depreciation_schedule"),r=u("#depreciation_schedule-inner tbody",a),o=u(".html-prototype",r),c=r.firstChild;c;)h=c.nextElementSibling,c.classList&&c.classList.contains("html-prototype")||r.removeChild(c),c=h;for(function(){var t=Y.payment*(12*Y.duration),e=Y.amount,n=t-e;u("thead .loan-paid-graph",a).style.width=e/t*100+"%",u("thead .interests-paid-graph",a).style.width=n/t*100+"%",u("thead .loan-paid-value",a).innerHTML=f(d("roundMoney",e))+"€",u("thead .interests-paid-value",a).innerHTML=f(d("roundMoney",n))+"€"}(),J;15>J;J++)if(p=$+J,y=T[p],"undefined"!=typeof y)for(r.appendChild(V("yearly",String(p),y)),g=$===p?E.getMonth()+2:1;15>D&&12>=g;++D&&++g)M=y[g],"undefined"!=typeof M&&(b=m[g]["short"]+" "+p,0===D&&(N.start=b),N.end=b,r.appendChild(V("monthly",b,M)));for(i("startdate").innerHTML=N.start,i("enddate").innerHTML=N.end,w=s("tbody td:first-child p",r),C=1/0,H=0,j=w.length;j>H;H++)_=w[H].offsetWidth,0!==_&&(C=Math.min(C,_));O.innerHTML="#depreciation_schedule-inner tbody td:first-child{width:"+C+"px}",k=u("#page-2").offsetWidth,u("#depreciation_schedule tr.graph-tab td.sep").style.width=(k-C)/2+C+"px"}}}())}()}();