/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
!function(){"use strict";function t(){var t,e,n,a,r=null,o=null;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},paymentYear:{get:function(){return r},set:function(t){t=parseFloat(t),console.log(t),isFinite(t)&&t>0&&(r=t,o=t*e)}},paymentTotal:{get:function(){return o}}})}function e(t){return null===t||"undefined"==typeof t}function n(t,n,a){function r(t,e,n){t&&e&&n&&(t.addEventListener||t.attachEvent).call(t,e,n)}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,i=0,l=0,u=t.length,s=n.length,c=a.length;for(o=0;u>o;o++)for(i=0;s>i;i++)for(l=0;c>l;l++)r(t[o],n[i],a[l])}function a(t,n,a){function r(t,e,n,a){t&&e&&n&&(g.createEvent?(a=new Event(e),t.dispatchEvent(a)):(a=g.createEventObject(),t.fireEvent("on"+e,a)))}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,i=0,l=t.length,u=n.length;for(o=0;l>o;o++)for(i=0;u>i;i++)r(t[o],n[i],a)}function r(t){(e(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var n={};for(var a in t){var r="wasCalc"===a?f[t[a]]:t[a];n[f[a]||a]=r}var o=JSON.stringify(n),i=o.slice(1).slice(0,-1).replace(/"/g,""),l=y.convert(m,i);try{history.pushState?history.pushState(null,null,"#"+l):location.hash="#"+l}catch(u){console.error("Could not change hash:",u)}}function o(){var t,e=location.hash.slice(1),n={};try{t=m.convert(y,e),n=JSON.parse(("{"+t+"}").replace(/(\{|,)([^:]+)|([a-zA-Z]+)/g,'$1"$2$3"'))}catch(a){console.error(a,a.stack)}var r={};for(var o in n){var i="wasCalc"===p.filter(function(t){return f[t]==o})[0]?p.filter(function(t){return f[t]==n[o]})[0]:n[o];r[p.filter(function(t){return f[t]==o})[0]||o]=i}return r}function i(t){return g.getElementById(t)}function l(t,e){return(e||g).querySelector(t)}function u(t,e){return(e||g).querySelectorAll(t)}function s(t){return i(t)||{}}function c(t,e){return l(t,e)||{}}function d(t,e){return t.hasOwnProperty(e)}t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,n,a=this,r=new t,o=0,i=1,l=0;if(a.payment*(12*a.duration)<a.amount)return 0;for(r.duration=a.duration,r.payment=a.payment;i>1e-4&&999>=l;)l++,e=o,o+=i,r.rate=o,n=r.calc_amount(),n<a.amount?(i/=10,o=e):n===a.amout&&(l=1e3);return o},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var h,f={amount:1,duration:2,rate:3,payment:4,paymentYear:5,wasCalc:9},p=Object.keys(f),m=new Base("!$&'()*+,;=-._~:@/?ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxyz0123456789"),y=new Base(":1234567890,.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),v={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},g=document,M=new t,w={},b={amount:0,duration:1,rate:2,payment:3},L={y:[],m:[]},C=i("graph_1-body_scroll"),F=l(".html-prototype",C),x=g.createElement("div");b=Object.keys(b),window.calculator=M,F.classList.remove("html-prototype"),x.appendChild(F),h=x.innerHTML,function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function f(e,n){return n=t(n),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*n).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(n).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*n).toFixed(0))/100).toFixed(2):void 0}function p(t){t+="";var n,a=t.match(/^(\d*)(?:[.,](\d*))?$/),r=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(e(a)||0===a.length)return"";for(;a[1].match(r);)a[1]=a[1].replace(r,"$1 $2");if(n=a[1],!e(a[2])){for(n+=",";a[2].match(o);)a[2]=a[2].replace(o,"$1 $2");n+=a[2]}return n}function m(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function y(){var t,e=function(e){return e!==t&&m(w[e].value.value)};for(t in w)d(w,t)&&(w[t].padlock.disabled=!m(w[t].value.value),w[t].calc.disabled=3!==Object.keys(w).filter(e).length)}function F(e){return w[e]&&w[e].value?(w[e].value.classList.remove("calculated"),t(w[e].value.value)):0}function x(t,e){var n=g.createElement("table"),a=g.createElement("tbody"),r=t.cloneNode(!0);return n.appendChild(a),r.classList.remove("html-prototype"),a.appendChild(r),a.innerHTML=T(a.innerHTML,e),a.firstChild}function _(t){for(var e,n,a=t.amount,r=a,o=t.payment,i=t.rate,l=i/1200,u=l+1,s=-o,c=s/(1-u),d=1,h=[];Math.round(100*r)>0;)e=Math.pow(u,d)*(a-c)+c,d++,n={interests:r*l,loan:o-r*l,amountAtBegin:r,loanLeft:e},r=e,h.push(n);return h}function T(t,e){return t=t.replace(/\{\s*([\w\.]+)\s*\}/g,function(t,n){var a=n.split("."),r=e,o=0,i=a.length;for(o;i>o&&(r="object"==typeof e?r[a[o]]:"",""!==r);o++);return r||""})}function k(t){if(document.createRange){var e,n=document.createRange();return n.selectNode(document.body),e=n.createContextualFragment(t),e.firstChild}var a=document.createElement("div");return a.innerHTML=t,a.firstChild}function Y(t){function r(t,n){for(var a=_(t),r=0,o=a.length,i=n.getMonth(),l=n.getFullYear(),u=l,s={};o>r&&l+16>u;r++){if(i++,i>11||r===o-1){for(var c in s[u])s[u].hasOwnProperty(c)&&(e(s[u].loan)&&(s[u].loan=0),s[u].loan+=s[u][c].loan,e(s[u].interests)&&(s[u].interests=0),s[u].interests+=s[u][c].interests);s[u].loanLeft=a[r===o-1?r:r-1].loanLeft}i>11&&(i=0,u++),e(s[u])&&(s[u]={}),s[u][i+1]=a[r]}return s}function o(t,e){e=[].slice.call(e);for(var n=0,a=e.length,r=0;a>r;r++){var o=l(t,e[r]);o&&(n=Math.max(o.offsetWidth,n))}return n}for(var s,d=M,m=new Date,m=new Date(m.getFullYear(),m.getMonth()+1),y=new Date(m.getFullYear()+Math.floor(d.duration),m.getMonth()+Math.round(d.duration%1*12)),g=r(d,m),w=15,b=m.getFullYear(),F={y:{},m:{}},x=0;w>x&&!e(s=g[b+x]);x++)F.y[String(b+x)]={loanLeft:s.loanLeft,loan:s.loan,interests:s.interests};for(var Y,A,x=-1,H=m.getMonth(),E=0;++x<w&&!e(Y=g[b+E])&&!e(A=Y[H+1]);)console.log(H,x,A),F.m[x+"_"+v[H+1]["short"]+" "+(b+E)]={loanLeft:A.loanLeft,loan:A.loan,interests:A.interests},H++,12==H&&(E++,H=0);console.log(F),O(i("datestart"),v[m.getMonth()+1].full+" "+m.getFullYear(),t),O(i("dateend"),v[y.getMonth()+1].full+" "+y.getFullYear(),t),O(i("refund_amount"),p(f("roundMoney",d.paymentTotal)),t),O(i("payback_amount"),p(f("roundMoney",d.amount)),t),O(i("interests_amount"),p(f("roundMoney",d.paymentTotal-d.amount)),t);for(var j=0,W=Object.keys(F.y),$=W.length;$>j;j++){var J=W[j],N=F.y[J],B=function(){return J==m.getFullYear()&&J==y.getFullYear()?y.getMonth()-m.getMonth():J==m.getFullYear()?12-m.getMonth():J==y.getFullYear()?y.getMonth()+1:12}()/12;if(e(L.y[j])){var V=T(h,{type:"year",label:J,payment:p(f("roundMoney",d.paymentYear*B))+" €",loan_paid:p(f("roundMoney",N.loan))+"€",loan_width:f("roundMoney",N.loan)/(12*d.payment)*100+"%",interests_paid:p(f("roundMoney",N.interests))+"€",interests_width:f("roundMoney",N.interests)/(12*d.payment)*100+"%"}),q=k(V);L.y.push(q),C.appendChild(q),q.classList.add("inside"),j===$-1&&q.classList.add("last")}else L.y[j].classList.add("inside"),j===$-1?L.y[j].classList.add("last"):L.y[j].classList.remove("last"),c(".date p",L.y[j]).innerHTML=J,c(".payment p",L.y[j]).innerHTML=p(f("roundMoney",d.paymentYear*B))+" €",c(".refund p",L.y[j]).innerHTML=p(f("roundMoney",N.loan))+"€",c(".interests p",L.y[j]).innerHTML=p(f("roundMoney",N.interests))+"€"}for(;w>j;j++){var P=L.y[j];e(P)||(P.classList.remove("inside"),P.classList.remove("last"))}var z=u(".line-year",C);setTimeout(function(){var t=o(".date",z),r=o(".payment",z),u=o(".refund p",z),s=o(".interests p",z),c=t+r,h=Math.max.apply(null,Object.keys(F.y).map(function(t){return F.y[t].loan})),f=Math.max.apply(null,Object.keys(F.y).map(function(t){return F.y[t].interests})),p=h/f,m=(d.amount/(d.paymentTotal-d.amount),"#graph_1 .graph_1-line.line-year "),y=m+".date{width:"+t+"px}\n"+m+".payment{width:"+r+"px}\n"+m+".refund{min-width:"+u+"px;flex:"+p+" 0 0}\n"+m+".interests{min-width:"+s+"px;flex:1 0 0}\n";S.innerHTML=y,D||(D=!0,n(window,"resize",function(t){console.log(t);for(var n=0;$>n;n++){var a=F.y[W[n]],r=l(".refund",z[0]),o=(l(".interests",z[0]),r.offsetWidth/r.offsetWidth);if(!e(a)){var u=z[n],d=l(".refund .graph-elem",u),f=l(".interests .graph-elem",u);d.style.width=o*r.offsetWidth*(a.loan/h)+"px",f.style.width=r.offsetWidth*o*(a.interests/h)+"px"}}var m=i("graph_1_head"),v=m.offsetWidth,g=Math.max(s,(v-(c+40))/(p+1)),M=v-g;console.log(c,(v-(c+40))/(p+1)),S.innerHTML=y+"#graph_1 .left{min-width:"+M+"px;max-width:"+M+"px;width:"+M+"px;}\n#graph_1 .right{min-width:"+g+"px;max-width:"+g+"px;width:"+g+"px;}\n"})),a(window,"resize")},1e3)}function O(t,n,a){function r(){var e=o.offsetWidth;return 0===e&&0!=n.length?setTimeout(r,10):(t.classList.remove("not-animated"),t.classList.add("animating"),t.style.width=e+"px",t.style.height=o.offsetHeight+"px",void setTimeout(function(){t.removeChild(t.lastChild),t.classList.remove("animating"),t.style.width=""},500))}if(a=a===!0,!e(t)){if(a)return void(t.innerHTML="<span>"+n+"</span>");var o=k("<span>"+n+"</span>");t.style.height=t.firstChild.offsetHeight+"px",t.style.width=t.firstChild.offsetWidth+"px",t.classList.add("not-animated"),t.insertBefore(o,t.firstChild),setTimeout(r,10)}}var A,H,E,S=g.createElement("style"),j=u("button.repeatable"),W=function(t){var e,r,o,i=j[t],l=i.getAttribute("data-timer-basestep")||500;n(i,"mousedown",function(){o++,r=l/(Math.log(Math.pow(o,2))+1),e=setTimeout(function(){a(i,"mousedown")},r)}),n([i,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),r=l,o=0}),a(i,"mouseup")},$=function(e){var a=b[e];w[a]={calc:i(a+"-button"),value:i(a+"-value"),buttonsContainer:i(a+"-buttons-plus-minus-container"),padlock:i(a+"-padlock"),plus:i(a+"-plus"),minus:i(a+"-minus")},w[a].value.setAttribute("data-placeholder",w[a].value.placeholder),w[a].calculate=function(){var t=b.filter(function(t){return t!==a}),e=a;return function(){var n,a,o=M,i=w[e].value;for(n in t)d(t,n)&&(o[t[n]]=F(t[n]));a=o["calc_"+e](),"payment"===e?M.paymentYear=12*a:M.paymentYear=M.payment,M[e]=a,i.value=p(f(e,a)),r({amount:parseFloat(f("amount",o.amount)),duration:parseFloat(f("duration",o.duration)),rate:parseFloat(f("rate",o.rate)),payment:parseFloat(f("payment",o.payment)),paymentYear:parseFloat(f("payment",o.paymentYear)),wasCalc:e}),i.classList.add("calculated"),y(),Y()}}(),n(w[a].calc,"click",w[a].calculate),n([w[a].padlock],"click",function(){var t=w[a].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===b.filter(function(t){return w[t].buttonsContainer.classList.contains("locked")}).length;b.forEach(function(t){var n=w[t].buttonsContainer;n.classList.contains("locked")||e!==!0?n.classList.remove("increment"):n.classList.add("increment")})}}()),n([w[a].plus,w[a].minus],"mousedown",function(){var e=w[a].value,n=a;return function(r){var o,i,l,u,s,c;switch(o=r.target.id===n+"-plus"?1:r.target.id===n+"-minus"?-1:0,n){case"duration":u=-.001,i=1,l=[0,+(1/0)];break;case"amount":case"payment":for(s=1,c=t(e.value);c>100-o;s*=10)c/=10;u=.001,i=s,l=[0,+(1/0)];break;case"rate":u=.001,i=t(e.value)>10?1:t(e.value)<1-.001*o?.01:.1,l=[0,10]}e.value=p(f(n,Math.max(l[0],Math.min(l[1],t(e.value)+i*o)).toFixed(2)-u)),y(),b.forEach(function(t){t!==a&&w[t].buttonsContainer.classList.contains("increment")&&w[t].calculate()})}}()),n(w[a].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),n(w[a].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!m(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),y()}),n(w[a].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault(),13==(t.which||t.keyCode)&&w[a].calculate()}),n(w[a].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),m(t.value)?t.value=p(f(a,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),n(i("toggle-year_month-input"),"change",function(){function t(){}i("depreciation_schedule"),i("toggle-year_month-input");return t(),t}())},J=o();for(S.id="dynamicStylesheet",l("head").appendChild(S),A=0,H=j.length;H>A;A++)W(A);for(A in b)d(b,A)&&$(A);if(0!==Object.keys(J).length&&J.constructor===Object){for(A in J)console.log(A,b),d(J,A)&&(M[A]=J[A],w[A]&&(w[A].value.value=p(f("paymentYear"!=A?A:"payment",J[A]))));E=w[J.wasCalc],4===Object.keys(w).filter(function(t){return m(w[t].value.value)}).length&&(E&&E.value&&E.value.classList.add("calculated"),Y(!0))}y();var D=!1;window.switchText=O,n([].slice.call(u(".pager-button")),"click",function(){var t=l("body");return function(){if(t.setAttribute("data-page",this.getAttribute("data-page-target")),"pager-button-1_2"===this.id){var n,a,r,o,c,d,h,m,y,g,w,b,L,C,F,T=M,k=_(T),Y=new Date,O=Y.getMonth(),A=Y.getFullYear(),H={},E=0,j=k.length,W=Y.getFullYear(),$=0,J=0,D={},N=function(t,e,n){var a="yearly"===t?12:1;return x(o,{type:t,label:e,loan_paid:p(f("roundMoney",n.loan))+"€",loan_width:f("roundMoney",n.loan)/(T.payment*a)*100+"%",interests_paid:p(f("roundMoney",n.interests))+"€",interests_width:f("roundMoney",n.interests)/(T.payment*a)*100+"%"})};for(console.log(O,A),E;j>E;E++){if(O++,O>11||E===j-1){for(n in H[A])H[A].hasOwnProperty(n)&&(e(H[A].loan)&&(H[A].loan=0),H[A].loan+=H[A][n].loan,e(H[A].interests)&&(H[A].interests=0),H[A].interests+=H[A][n].interests);H[A].loanLeft=k[E===j-1?E:E-1].loanLeft}O>11&&(O=0,A++),null===H[A]&&(H[A]={}),H[A][O+1]=k[E]}for(a=i("depreciation_schedule"),r=l("#depreciation_schedule-inner tbody",a),o=l(".html-prototype",r),c=r.firstChild;c;)d=c.nextElementSibling,c.classList&&c.classList.contains("html-prototype")||r.removeChild(c),c=d;for(function(){var t=T.payment*(12*T.duration),e=T.amount,n=t-e;l("thead .loan-paid-graph",a).style.width=e/t*100+"%",l("thead .interests-paid-graph",a).style.width=n/t*100+"%",l("thead .loan-paid-value",a).innerHTML=p(f("roundMoney",e))+"€",l("thead .interests-paid-value",a).innerHTML=p(f("roundMoney",n))+"€"}(),$;15>$;$++)if(h=W+$,m=H[h],"undefined"!=typeof m)for(r.appendChild(N("yearly",String(h),m)),y=W===h?Y.getMonth()+2:1;15>J&&12>=y;++J&&++y)g=m[y],"undefined"!=typeof g&&(w=v[y]["short"]+" "+h,0===J&&(D.start=w),D.end=w,r.appendChild(N("monthly",w,g)));for(s("startdate").innerHTML=D.start,s("enddate").innerHTML=D.end,b=u("tbody td:first-child p",r),L=1/0,E=0,j=b.length;j>E;E++)C=b[E].offsetWidth,0!==C&&(L=Math.min(L,C));S.innerHTML="#depreciation_schedule-inner tbody td:first-child{width:"+L+"px}",F=l("#page-2").offsetWidth,l("#depreciation_schedule tr.graph-tab td.sep").style.width=(F-L)/2+L+"px"}}}())}()}();