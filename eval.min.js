/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
"use strict";function Calculator(){var t,e,a,n;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}}})}function attach(t,e,a){function n(t,e,a){t&&e&&a&&(t.addEventListener?t.addEventListener(e,a):t.attachEvent(e,a))}null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var r=0,o=0,l=0,u=t.length,i=e.length,c=a.length;for(r=0;u>r;r++)for(o=0;i>o;o++)for(l=0;c>l;l++)n(t[r],e[o],a[l])}function detach(t,e,a){function n(t,e,a){t&&e&&a&&(t.removeEventListener?t.removeEventListener(e,a):t.detachEvent(e,a))}null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var r=0,o=0,l=0,u=t.length,i=e.length,c=a.length;for(r=0;u>r;r++)for(o=0;i>o;o++)for(l=0;c>l;l++)n(t[r],e[o],a[l])}function triggerEvent(t,e,a){function n(t,e,a){t&&e&&a&&(c.createEvent?(r=new Event(e))&&t.dispatchEvent(r):(r=c.createEventObject())&&t.fireEvent("on"+e,r))}null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var r,o=0,l=0,u=t.length,i=e.length,c=document;for(o=0;u>o;o++)for(l=0;i>l;l++)n(t[o],e[l],a)}function gei(t){return document.getElementById(t)}function qs(t){return document.querySelector(t)}function qsa(t){return document.querySelectorAll(t)}function setUrlHash(t){"undefined"!=typeof t&&null!==t&&""!==t||(history.pushState?history.pushState(null,null,""):location.hash="");var e=JSON.stringify(t),a=btoa(e);try{history.pushState?history.pushState(null,null,"#"+a):location.hash="#"+a}catch(n){console.error("Could not change hash:",n)}}function getUrlHash(){var t=location.hash.replace(/^#/,""),e={};try{e=JSON.parse(atob(t))}catch(a){}return e}var months={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}};Calculator.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var t,e=this,a=new Calculator,n=0,r=1,o=0;if(e.payment*(12*e.duration)<e.amount)return 0;for(a.duration=e.duration,a.payment=e.payment;r>1e-4&&999>=o;){o++,t=n,n+=r,a.rate=n;var l=a.calc_amount();l<e.amount?(r/=10,n=t):l==e.amout&&(o=1e3)}return n},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var calculator=new Calculator,formElems={},calculatorVariables={amount:0,duration:1,rate:2,payment:3};calculatorVariables=Object.keys(calculatorVariables),function(){function t(t,e){return e=o(e),-1!=["amount","payment","rate"].indexOf(t)?(parseFloat(Math.ceil(100*e).toFixed(0))/100).toFixed(2):"duration"==t?Math.ceil(e).toFixed(0):"roundMoney"==t?(parseFloat(Math.round(100*e).toFixed(0))/100).toFixed(2):void 0}function e(t){t+="";var e=t.match(/^(\d*)(?:[.,](\d*))?$/),a=/(.*\d)(\d{3})/;if(null===e||0==e.length)return"";for(;e[1].match(a);)e[1]=e[1].replace(a,"$1 $2");var n=e[1];if("undefined"!=typeof e[2]){var r=/(\d{3})(.*\d)/;for(n+=",";e[2].match(r);)e[2]=e[2].replace(r,"$1 $2");n+=e[2]}return n}function a(){for(var t in formElems)formElems[t].padlock.disabled=!n(formElems[t].value.value),formElems[t].calc.disabled=3!=Object.keys(formElems).filter(function(e){return e!=t&&n(formElems[e].value.value)}).length}function n(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function r(t){return formElems[t]&&formElems[t].value?(formElems[t].value.classList.remove("calculated"),o(formElems[t].value.value)):0}function o(t){return parseFloat((t+"").replace(/ /g,"").replace(/,/g,".")||0)}function l(t){for(var e=t.amount,a=e,n=t.payment,r=t.rate,o=r/1200,l=o+1,u=-n,i=u/(1-l),c=1,s=[];Math.round(100*a)>0;){var f=Math.pow(l,c)*(e-i)+i;c++;var d={interests:a*o,loan:n-a*o,amountAtBegin:a,loanLeft:f};a=f,s.push(d)}return s}function u(t,e){var a=document.createElement("table"),n=document.createElement("tbody");a.appendChild(n);var r=t.cloneNode(!0);return r.classList.remove("html-prototype"),n.appendChild(r),n.innerHTML=i(n.innerHTML,e),n.firstChild}function i(t,e){return t=t.replace(/\$\{\s*([\w\.]+)\s*\}/g,function(t,a){for(var n=a.split("."),r=e,o=0,l=n.length;l>o&&(r="object"==typeof e?r[n[o]]:"",""!=r);o++);return r||""})}var c=document.createElement("style");c.id="dynamicStylesheet",qs("head").appendChild(c),function(){for(var t=qsa("button.repeatable"),e=0,a=t.length;a>e;e++)!function(){var a,n,r,o=t[e],l=o.getAttribute("data-timer-basestep")||500;attach(o,"mousedown",function(){r++,n=l/(Math.log(Math.pow(r,2))+1),a=setTimeout(function(){triggerEvent(o,"mousedown")},n)}),attach([o,window],["mouseup","mouseleave","blur"],function(){clearTimeout(a),n=l,r=0}),triggerEvent(o,"mouseup")}()}();for(var s in calculatorVariables)!function(){var l=calculatorVariables[s];formElems[l]={calc:gei(l+"-button"),value:gei(l+"-value"),buttonsContainer:gei(l+"-buttons-plus-minus-container"),padlock:gei(l+"-padlock"),plus:gei(l+"-plus"),minus:gei(l+"-minus")},formElems[l].value.setAttribute("data-placeholder",formElems[l].value.placeholder),formElems[l].calculate=function(){var n=calculatorVariables.filter(function(t){return t!=l}),o=l;return function(){var l=calculator;for(var u in n)l[n[u]]=r(n[u]);var i=calculator["calc_"+o]();calculator[o]=i;var c=formElems[o].value;c.value=e(t(o,i)),setUrlHash({amount:l.amount,duration:l.duration,rate:l.rate,payment:l.payment}),c.classList.add("calculated"),a()}}(),attach(formElems[l].calc,"click",formElems[l].calculate),attach([formElems[l].padlock],"click",function(){var t=formElems[l].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===calculatorVariables.filter(function(t){return formElems[t].buttonsContainer.classList.contains("locked")}).length;calculatorVariables.forEach(function(t){var a=formElems[t].buttonsContainer;a.classList.contains("locked")||e!==!0?a.classList.remove("increment"):a.classList.add("increment")})}}()),attach([formElems[l].plus,formElems[l].minus],"mousedown",function(){var n=formElems[l].value,r=l;return function(u){var i;i=u.target.id==r+"-plus"?1:u.target.id==r+"-minus"?-1:0;var c,s,f;switch(r){case"duration":f=-.001,c=1,s=[0,+(1/0)];break;case"amount":case"payment":for(var d=1,m=o(n.value);m>100-i;d*=10,m/=10);f=.001,c=d,s=[0,+(1/0)];break;case"rate":f=.001,c=o(n.value)>10?1:o(n.value)<1-.001*i?.01:.1,s=[0,10]}n.value=e(t(r,Math.max(s[0],Math.min(s[1],o(n.value)+c*i)).toFixed(2)-f)),a(),calculatorVariables.forEach(function(t){t!=l&&formElems[t].buttonsContainer.classList.contains("increment")&&formElems[t].calculate()})}}()),attach(formElems[l].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),attach(formElems[l].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!n(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),a()}),attach(formElems[l].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault()}),attach(formElems[l].value,"blur",function(){var a=this;a.placeholder=a.getAttribute("data-placeholder"),n(a.value)?a.value=e(t(l,a.value)):""==a.value?a.setCustomValidity(""):a.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),attach(gei("toggle-year_month-input"),"change",function(){function t(){}gei("depreciation_schedule"),gei("toggle-year_month-input");return t(),t}())}();var f=getUrlHash();if(f!={})for(var s in calculatorVariables){var d=calculatorVariables[s];calculator[d]=f[d],formElems[d].value.value=e(t(d,f[d]))}a(),attach([].slice.call(qsa(".pager-button")),"click",function(){var a=qs("body");return function(){function n(a,n,o){var l="yearly"===a?12:1;return u(g,{type:a,label:n,loan_paid:e(t("roundMoney",o.loan))+"€",loan_width:t("roundMoney",o.loan)/(r.payment*l)*100+"%",interests_paid:e(t("roundMoney",o.interests))+"€",interests_width:t("roundMoney",o.interests)/(r.payment*l)*100+"%"})}if(a.setAttribute("data-page",this.getAttribute("data-page-target")),"pager-button-1_2"==this.id){var r=calculator,o=l(r),i=new Date,s=i.getMonth(),f=i.getFullYear();console.log(s,f);for(var d={},m=0,h=o.length;h>m;m++){if(s++,s>11||m==h-1){for(var p in d[f])"undefined"==typeof d[f].loan&&(d[f].loan=0),d[f].loan+=d[f][p].loan,"undefined"==typeof d[f].interests&&(d[f].interests=0),d[f].interests+=d[f][p].interests;d[f].loanLeft=o[m==h-1?m:m-1].loanLeft}s>11&&(s=0,f++),null==d[f]&&(d[f]={}),d[f][s+1]=o[m]}for(var v=gei("depreciation_schedule"),y=v.querySelector("#depreciation_schedule-inner tbody"),g=y.querySelector(".html-prototype"),b=y.firstChild;b;){var E=b.nextElementSibling;b.classList&&b.classList.contains("html-prototype")||y.removeChild(b),b=E}!function(){var a=r.payment*(12*r.duration),n=r.amount,o=a-n;v.querySelector("thead .loan-paid-graph").style.width=n/a*100+"%",v.querySelector("thead .interests-paid-graph").style.width=o/a*100+"%",v.querySelector("thead .loan-paid-value").innerHTML=e(t("roundMoney",n))+"€",v.querySelector("thead .interests-paid-value").innerHTML=e(t("roundMoney",o))+"€"}();for(var M=i.getFullYear(),C=0,L={},w=0;15>w;w++){var A=M+w,F=d[A];if("undefined"!=typeof F){y.appendChild(n("yearly",A+"",F));for(var S=M==A?i.getMonth()+2:1;15>C&&12>=S;++C&&++S){var q=F[S];if("undefined"!=typeof q){var _=months[S]["short"]+" "+A;0===C&&(L.start=_),L.end=_,y.appendChild(n("monthly",_,q))}}}}!function(t){t&&(t.innerHTML=L.start)}(gei("startdate")),function(t){t&&(t.innerHTML=L.end)}(gei("enddate"));for(var k=y.querySelectorAll("tbody td:first-child p"),V=1/0,m=0,h=k.length;h>m;m++){var x=k[m].offsetWidth;0!=x&&(V=Math.min(V,x))}c.innerHTML="#depreciation_schedule-inner tbody td:first-child{width:"+V+"px}";var H=qs("#page-2").offsetWidth;qs("#depreciation_schedule tr.graph-tab td.sep").style.width=(H-V)/2+V+"px"}}}())}();