/*jslint plusplus: true */
!function(){"use strict";function t(){var t,e,n,a;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}}})}function e(t){return null===t||"undefined"==typeof t}function n(t,n,a){function r(t,e,n){t&&e&&n&&(t.addEventListener||t.attachEvent)(e,n)}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,u=0,i=0,l=t.length,c=n.length,s=a.length;for(o=0;l>o;o++)for(u=0;c>u;u++)for(i=0;s>i;i++)r(t[o],n[u],a[i])}function a(t,n,a){function r(t,e,n,a){t&&e&&n&&(d.createEvent?(a=new Event(e),t.dispatchEvent(a)):(a=d.createEventObject(),t.fireEvent("on"+e,a)))}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,u=0,i=t.length,l=n.length;for(o=0;i>o;o++)for(u=0;l>u;u++)r(t[o],n[u],a)}function r(t){(e(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var n=JSON.stringify(t),a=btoa(n);try{history.pushState?history.pushState(null,null,"#"+a):location.hash="#"+a}catch(r){console.error("Could not change hash:",r)}}function o(){var t=location.hash.replace(/^#/,""),e={};try{e=JSON.parse(atob(t))}catch(n){}return e}function u(t){return d.getElementById(t)}function i(t){return u(t)||{}}function l(t){return d.querySelector(t)}function c(t){return d.querySelectorAll(t)}t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,n,a=this,r=new t,o=0,u=1,i=0;if(a.payment*(12*a.duration)<a.amount)return 0;for(r.duration=a.duration,r.payment=a.payment;u>1e-4&&999>=i;)i++,e=o,o+=u,r.rate=o,n=r.calc_amount(),n<a.amount?(u/=10,o=e):n===a.amout&&(i=1e3);return o},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var s={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},d=document,h=new t,f={},p={amount:0,duration:1,rate:2,payment:3};p=Object.keys(p),function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function m(e,n){return n=t(n),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*n).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(n).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*n).toFixed(0))/100).toFixed(2):void 0}function v(t){t+="";var n,a=t.match(/^(\d*)(?:[.,](\d*))?$/),r=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(e(a)||0===a.length)return"";for(;a[1].match(r);)a[1]=a[1].replace(r,"$1 $2");if(n=a[1],!e(a[2])){for(n+=",";a[2].match(o);)a[2]=a[2].replace(o,"$1 $2");n+=a[2]}return n}function y(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function g(){var t,e=function(e){return e!==t&&y(f[e].value.value)};for(t in f)f.hasOwnProperty(t)&&(f[t].padlock.disabled=!y(f[t].value.value),f[t].calc.disabled=3!==Object.keys(f).filter(e).length)}function b(e){return f[e]&&f[e].value?(f[e].value.classList.remove("calculated"),t(f[e].value.value)):0}function M(t,e){return t=t.replace(/\$\{\s*([\w\.]+)\s*\}/g,function(t,n){var a=n.split("."),r=e,o=0,u=a.length;for(o;u>o&&(r="object"==typeof e?r[a[o]]:"",""!==r);o++);return r||""})}function w(t,e){var n=d.createElement("table"),a=d.createElement("tbody"),r=t.cloneNode(!0);return n.appendChild(a),r.classList.remove("html-prototype"),a.appendChild(r),a.innerHTML=M(a.innerHTML,e),a.firstChild}function C(t){for(var e,n,a=t.amount,r=a,o=t.payment,u=t.rate,i=u/1200,l=i+1,c=-o,s=c/(1-l),d=1,h=[];Math.round(100*r)>0;)e=Math.pow(l,d)*(a-s)+s,d++,n={interests:r*i,loan:o-r*i,amountAtBegin:r,loanLeft:e},r=e,h.push(n);return h}var L,S,F=d.createElement("style"),k=c("button.repeatable"),A=function(t){var e,r,o,u=k[t],i=u.getAttribute("data-timer-basestep")||500;n(u,"mousedown",function(){o++,r=i/(Math.log(Math.pow(o,2))+1),e=setTimeout(function(){a(u,"mousedown")},r)}),n([u,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),r=i,o=0}),a(u,"mouseup")},_=function(e){var a=p[e];f[a]={calc:u(a+"-button"),value:u(a+"-value"),buttonsContainer:u(a+"-buttons-plus-minus-container"),padlock:u(a+"-padlock"),plus:u(a+"-plus"),minus:u(a+"-minus")},f[a].value.setAttribute("data-placeholder",f[a].value.placeholder),f[a].calculate=function(){var t=p.filter(function(t){return t!==a}),e=a;return function(){var n,a=h,o=a["calc_"+e](),u=f[e].value;for(n in t)t.hasOwnProperty(n)&&(a[t[n]]=b(t[n]));h[e]=o,u.value=v(m(e,o)),r({amount:a.amount,duration:a.duration,rate:a.rate,payment:a.payment}),u.classList.add("calculated"),g()}}(),n(f[a].calc,"click",f[a].calculate),n([f[a].padlock],"click",function(){var t=f[a].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===p.filter(function(t){return f[t].buttonsContainer.classList.contains("locked")}).length;p.forEach(function(t){var n=f[t].buttonsContainer;n.classList.contains("locked")||e!==!0?n.classList.remove("increment"):n.classList.add("increment")})}}()),n([f[a].plus,f[a].minus],"mousedown",function(){var e=f[a].value,n=a;return function(r){var o,u,i,l,c,s;switch(o=r.target.id===n+"-plus"?1:r.target.id===n+"-minus"?-1:0,n){case"duration":l=-.001,u=1,i=[0,+(1/0)];break;case"amount":case"payment":for(c=1,s=t(e.value);s>100-o;c*=10)s/=10;l=.001,u=c,i=[0,+(1/0)];break;case"rate":l=.001,u=t(e.value)>10?1:t(e.value)<1-.001*o?.01:.1,i=[0,10]}e.value=v(m(n,Math.max(i[0],Math.min(i[1],t(e.value)+u*o)).toFixed(2)-l)),g(),p.forEach(function(t){t!==a&&f[t].buttonsContainer.classList.contains("increment")&&f[t].calculate()})}}()),n(f[a].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),n(f[a].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!y(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),g()}),n(f[a].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault()}),n(f[a].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),y(t.value)?t.value=v(m(a,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),n(u("toggle-year_month-input"),"change",function(){function t(){}u("depreciation_schedule"),u("toggle-year_month-input");return t(),t}())},O=o();for(F.id="dynamicStylesheet",l("head").appendChild(F),L=0,S=k.length;S>L;L++)A(L);for(L in p)p.hasOwnProperty(L)&&_(L);if(0===Object.keys(O).length&&O.constructor===Object)for(L in p)p.hasOwnProperty(L)&&(S=p[L],h[S]=O[S],f[S].value.value=v(m(S,O[S])));g(),n([].slice.call(c(".pager-button")),"click",function(){var t=l("body");return function(){if(t.setAttribute("data-page",this.getAttribute("data-page-target")),"pager-button-1_2"===this.id){var n,a,r,o,c,d,f,p,y,g,b,M,L,S,k,A=h,_=C(A),O=new Date,E=O.getMonth(),q=O.getFullYear(),x={},T=0,J=_.length,$=O.getFullYear(),j=0,H=0,P={},N=function(t,e,n){var a="yearly"===t?12:1;return w(o,{type:t,label:e,loan_paid:v(m("roundMoney",n.loan))+"€",loan_width:m("roundMoney",n.loan)/(A.payment*a)*100+"%",interests_paid:v(m("roundMoney",n.interests))+"€",interests_width:m("roundMoney",n.interests)/(A.payment*a)*100+"%"})};for(console.log(E,q),T;J>T;T++){if(E++,E>11||T===J-1){for(n in x[q])x[q].hasOwnProperty(n)&&(e(x[q].loan)&&(x[q].loan=0),x[q].loan+=x[q][n].loan,e(x[q].interests)&&(x[q].interests=0),x[q].interests+=x[q][n].interests);x[q].loanLeft=_[T===J-1?T:T-1].loanLeft}E>11&&(E=0,q++),null===x[q]&&(x[q]={}),x[q][E+1]=_[T]}for(a=u("depreciation_schedule"),r=a.querySelector("#depreciation_schedule-inner tbody"),o=r.querySelector(".html-prototype"),c=r.firstChild;c;)d=c.nextElementSibling,c.classList&&c.classList.contains("html-prototype")||r.removeChild(c),c=d;for(function(){var t=A.payment*(12*A.duration),e=A.amount,n=t-e;a.querySelector("thead .loan-paid-graph").style.width=e/t*100+"%",a.querySelector("thead .interests-paid-graph").style.width=n/t*100+"%",a.querySelector("thead .loan-paid-value").innerHTML=v(m("roundMoney",e))+"€",a.querySelector("thead .interests-paid-value").innerHTML=v(m("roundMoney",n))+"€"}(),j;15>j;j++)if(f=$+j,p=x[f],"undefined"!=typeof p)for(r.appendChild(N("yearly",String(f),p)),y=$===f?O.getMonth()+2:1;15>H&&12>=y;++H&&++y)g=p[y],"undefined"!=typeof g&&(b=s[y]["short"]+" "+f,0===H&&(P.start=b),P.end=b,r.appendChild(N("monthly",b,g)));for(i("startdate").innerHTML=P.start,i("enddate").innerHTML=P.end,M=r.querySelectorAll("tbody td:first-child p"),L=1/0,T=0,J=M.length;J>T;T++)S=M[T].offsetWidth,0!==S&&(L=Math.min(L,S));F.innerHTML="#depreciation_schedule-inner tbody td:first-child{width:"+L+"px}",k=l("#page-2").offsetWidth,l("#depreciation_schedule tr.graph-tab td.sep").style.width=(k-L)/2+L+"px"}}}())}()}();