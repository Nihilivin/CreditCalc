/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
!function(){"use strict";function t(){var t,e,a,n,r=null,i=null;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},paymentYear:{get:function(){return r},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(r=t,i=t*e)}},paymentTotal:{get:function(){return i}}})}function e(t){(isNA(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var e={};for(var a in t){var n="wasCalc"===a?o[t[a]]:t[a];e[o[a]||a]=n}var r=JSON.stringify(e),i=r.slice(1).slice(0,-1).replace(/"/g,""),l=u.convert(s,i);try{history.pushState?history.pushState(null,null,"#"+l):location.hash="#"+l}catch(c){console.error("Could not change hash:",c)}}function a(){var t,e=location.hash.slice(1),a={};try{t=s.convert(u,e),a=JSON.parse(("{"+t+"}").replace(/(\{|,)([^:]+)|([a-zA-Z]+)/g,'$1"$2$3"'))}catch(n){console.error(n,n.stack)}var r={};for(var i in a){var c="wasCalc"===l.filter(function(t){return o[t]==i})[0]?l.filter(function(t){return o[t]==a[i]})[0]:a[i];r[l.filter(function(t){return o[t]==i})[0]||i]=c}return r}var n=window,r=document;t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,a,n=this,r=new t,i=0,o=1,l=0;if(n.payment*(12*n.duration)<n.amount)return 0;for(r.duration=n.duration,r.payment=n.payment;o>1e-4&&999>=l;)l++,e=i,i+=o,r.rate=i,a=r.calc_amount(),a<n.amount?(o/=10,i=e):a===n.amout&&(l=1e3);return i},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var i,o={amount:1,duration:2,rate:3,payment:4,paymentYear:5,wasCalc:9},l=Object.keys(o),s=new Base("!$&'()*+,;=-._~:@/?ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxyz0123456789"),u=new Base(":1234567890,.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),c={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},h=new t,d={},p={amount:0,duration:1,rate:2,payment:3},f={y:[],m:[]},m=gei("graph_1-body_scroll"),g=gei("graph_1-body_scroll-container-years"),y=m.qs(".html-prototype"),v=r.createElement("div");n.formElems=d,p=Object.keys(p),window.calculator=h,y.classList.remove("html-prototype"),v.appendChild(y),i=v.innerHTML,attach(window,"load",function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function n(e,a){return a=t(a),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*a).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(a).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*a).toFixed(0))/100).toFixed(2):void 0}function o(t){t+="";var e,a=t.match(/^(\d*)(?:[.,](\d*))?$/),n=/(.*\d)(\d{3})/,r=/(\d{3})(.*\d)/;if(isNA(a)||0===a.length)return"";for(;a[1].match(n);)a[1]=a[1].replace(n,"$1 $2");if(e=a[1],!isNA(a[2])){for(e+=",";a[2].match(r);)a[2]=a[2].replace(r,"$1 $2");e+=a[2]}return e}function l(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function s(){var t,e=function(e){return e!==t&&l(d[e].value.value)};for(t in d)d.hop(t)&&(d[t].padlock.disabled=!l(d[t].value.value),d[t].calc.disabled=3!==Object.keys(d).filter(e).length)}function u(e){return d[e]&&d[e].value?(d[e].value.classList.remove("calculated"),t(d[e].value.value)):0}function y(t){for(var e=t.amount,a=1,n=[];Math.round(100*e)>0;){var r=t.amount,i=t.payment,o=t.rate,l=o/1200,s=l+1,u=-i,c=u/(1-s),h=Math.pow(s,a)*(r-c)+c;a++;var d={interests:e*l,loan:i-e*l,amountAtBegin:e,loanLeft:h};e=h,n.push(d)}return n}function v(t,e){return t=t.replace(/\{\s*([\w\.]+)\s*\}/g,function(t,a){var n=a.split("."),r=e,i=0,o=n.length;for(i;o>i&&(r="object"==typeof e?r[n[i]]:"",""!==r);i++);return r||""})}function w(t){if(document.createRange){var e,a=r.createRange();return a.selectNode(document.body),e=a.createContextualFragment(t),e.firstChild}var n=r.createElement("div");return n.innerHTML=t,n.firstChild}function M(t){function e(t,e){for(var a=y(t),n=0,r=a.length,i=e.getMonth(),o=e.getFullYear(),l=o,s={};r>n&&o+d+1>l;n++){if(i++,i>11||n===r-1){for(var u in s[l])s[l].hop(u)&&(isNA(s[l].loan)&&(s[l].loan=0),s[l].loan+=s[l][u].loan,isNA(s[l].interests)&&(s[l].interests=0),s[l].interests+=s[l][u].interests);s[l].loanLeft=a[n===r-1?n:n-1].loanLeft}i>11&&(i=0,l++),isNA(s[l])&&(s[l]={}),s[l][i+1]=a[n]}return s}function a(t,e){e=[].slice.call(e);for(var a=0,n=e.length,r=0;n>r;r++){var i=qs(t,e[r]);i&&(a=Math.max(i.offsetWidth,a))}return a}for(var r,l=h,s=new Date,s=new Date(s.getFullYear(),s.getMonth()+1),u=new Date(s.getFullYear()+Math.floor(l.duration),s.getMonth()+Math.round(l.duration%1*12)),d=15,p=e(l,s),M=s.getFullYear(),x={y:{},m:{}},L=0;d>L&&!isNA(r=p[M+L]);L++)x.y[String(M+L)]={loanLeft:r.loanLeft,loan:r.loan,interests:r.interests};for(var F,C,L=-1,N=s.getMonth(),k=0;++L<d&&!isNA(F=p[M+k])&&!isNA(C=F[N+1]);)console.log(N,L,C),x.m[L+"_"+c[N+1]["short"]+" "+(M+k)]={loanLeft:C.loanLeft,loan:C.loan,interests:C.interests},N++,12==N&&(k++,N=0);b(gei("datestart"),c[s.getMonth()+1].full+" "+s.getFullYear(),t),b(gei("dateend"),c[u.getMonth()+1].full+" "+u.getFullYear(),t),b(gei("refund_amount"),o(n("roundMoney",l.paymentTotal)),t),b(gei("payback_amount"),o(n("roundMoney",l.amount)),t),b(gei("interests_amount"),o(n("roundMoney",l.paymentTotal-l.amount)),t);for(var A=0,S=Object.keys(x.y),j=S.length;j>A;A++){var E=S[A],$=x.y[E],J=function(){return E==s.getFullYear()&&E==u.getFullYear()?u.getMonth()-s.getMonth():E==s.getFullYear()?12-s.getMonth():E==u.getFullYear()?u.getMonth()+1:12}()/12;if(isNA(f.y[A])){var W=v(i,{type:"year",label:E,payment:o(n("roundMoney",l.paymentYear*J))+" €",loan_paid:o(n("roundMoney",$.loan))+"€",loan_width:n("roundMoney",$.loan)/(12*l.payment)*100+"%",interests_paid:o(n("roundMoney",$.interests))+"€",interests_width:n("roundMoney",$.interests)/(12*l.payment)*100+"%"}),D=w(W);f.y.push(D),g.appendChild(D),D.classList.add("inside"),A===j-1&&D.classList.add("last")}else f.y[A].classList.add("inside"),A===j-1?f.y[A].classList.add("last"):f.y[A].classList.remove("last"),f.y[A].qsN(".date p").innerHTML=E,f.y[A].qsN(".payment p").innerHTML=o(n("roundMoney",l.paymentYear*J))+" €",f.y[A].qsN(".refund p").innerHTML=o(n("roundMoney",$.loan))+"€",f.y[A].qsN(".interests p").innerHTML=o(n("roundMoney",$.interests))+"€"}for(;d>A;A++){var z=f.y[A];isNA(z)||(z.classList.remove("inside"),z.classList.remove("last"))}var V=gei("graph_1_head"),B=V.offsetWidth,R=0,U=25,P=qs(".line-year .date",g),G=qs("p",P);timeoutUntil(function(){function t(t){Y=!0,B=V.offsetWidth,R=0;for(var a=B-(s+40),n=Math.max(o,a/(h+1)),r=Math.max(i,Math.min(a-n,a/(h+1)*h)),d=n,f=B-d,y=Math.max(u/r,c/n),v=qs(".refund .graph-elem",V),w=qs(".interests .graph-elem",V),M=Math.max(l.amount/r,(l.paymentTotal-l.amount)/n),b=0;j>b;b++){var L=x.y[S[b]];if(!isNA(L)){var F=e[b],C=qs(".refund .graph-elem",F),N=qs(".interests .graph-elem",F);C.style.width=L.loan/y+"px",N.style.width=L.interests/y+"px"}}_.innerHTML=p+"#graph_1 .left{min-width:"+f+"px;max-width:"+f+"px;width:"+f+"px;}\n#graph_1 .right{min-width:"+d+"px;max-width:"+d+"px;width:"+d+"px;}\n#graph_1-padder{min-height:"+geiN("calculator-padder").offsetHeight+"px;max-height:"+geiN("basic_data").offsetHeight+"px;}",v.style.width=l.amount/M+"px",w.style.width=(l.paymentTotal-l.amount)/M+"px";var k=geiN("graph_1-body_scroll-container").offsetHeight;(geiN("graph_1-scroll_area").style||{}).maxHeight=k+"px",q.style.height=m.offsetHeight/g.offsetHeight*(O.offsetHeight-10)}var e=qsa(".line-year",g),n=a(".date",e),r=a(".payment",e),i=a(".refund p",e),o=a(".interests p",e),s=n+r,u=Math.max.apply(null,Object.keys(x.y).map(function(t){return x.y[t].loan})),c=Math.max.apply(null,Object.keys(x.y).map(function(t){return x.y[t].interests})),h=u/c,d=(l.amount/(l.paymentTotal-l.amount),"#graph_1 .graph_1-line.line-year "),p=d+".date{width:"+n+"px}\n"+d+".payment{width:"+r+"px}\n"+d+".refund{min-width:"+i+"px;flex:"+h+" 0 0}\n"+d+".interests{min-width:"+o+"px;flex:1 0 0}\n";_.innerHTML=p,T?(detach(window,"resize",H),H=t,attach(window,"resize",H)):(T=!0,H=t,attach(window,"resize",H)),triggerEvent(window,"resize")},10,function(){return P.offsetWidth==G.offsetWidth+10||Y&&++R>U})}function b(t,e,a){function n(){var e=r.offsetWidth;t.classList.remove("prepare"),t.classList.add("doing"),t.style.width=e+"px",t.style.height=r.offsetHeight+"px",setTimeout(function(){t.removeChild(t.lastChild),t.classList.remove("doing"),t.style.width=""},500)}if(a=a===!0,!isNA(t)){if(a)return void(t.innerHTML="<span>"+e+"</span>");var r=w("<span>"+e+"</span>");t.style.height=t.firstChild.offsetHeight+"px",t.style.width=t.firstChild.offsetWidth+"px",t.classList.add("prepare"),t.insertBefore(r,t.firstChild),timeoutUntil(n,10,function(){return 0!==r.offsetWidth||0!=e.length})}}var x,L,F,_=r.createElement("style"),C=qsa("button.repeatable"),N=function(t){var e,a,n,r=C[t],i=r.getAttribute("data-timer-basestep")||500;attach(r,"mousedown",function(){n++,a=i/(Math.log(Math.pow(n,2))+1),e=setTimeout(function(){triggerEvent(r,"mousedown")},a)}),attach([r,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),a=i,n=0}),triggerEvent(r,"mouseup")},k=function(a){var r=p[a];d[r]={calc:gei(r+"-button"),value:gei(r+"-value"),buttonsContainer:gei(r+"-buttons-plus-minus-container"),padlock:gei(r+"-padlock"),plus:gei(r+"-plus"),minus:gei(r+"-minus")},d[r].value.setAttribute("data-placeholder",d[r].value.placeholder),d[r].calculate=function(){var t=p.filter(function(t){return t!==r}),a=r;return function(){var r,i,l=h,c=d[a].value;for(r in t)t.hop(r)&&(l[t[r]]=u(t[r]));i=l["calc_"+a](),"payment"===a?l.paymentYear=12*i:l.paymentYear=l.payment,l[a]=i,c.value=o(n(a,i)),e({amount:parseFloat(n("amount",l.amount)),duration:parseFloat(n("duration",l.duration)),rate:parseFloat(n("rate",l.rate)),payment:parseFloat(n("payment",l.payment)),paymentYear:parseFloat(n("payment",l.paymentYear)),wasCalc:a}),c.classList.add("calculated"),s(),M()}}(),attach(d[r].calc,"click",d[r].calculate),attach([d[r].padlock],"click",function(){var t=d[r].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===p.filter(function(t){return d[t].buttonsContainer.classList.contains("locked")}).length;p.forEach(function(t){var a=d[t].buttonsContainer;a.classList.contains("locked")||e!==!0?a.classList.remove("increment"):a.classList.add("increment")})}}()),attach([d[r].plus,d[r].minus],"mousedown",function(){var e=d[r].value,a=r;return function(i){var l,u,c,h,f,m;switch(l=i.target.id===a+"-plus"?1:i.target.id===a+"-minus"?-1:0,a){case"duration":h=-.001,u=1,c=[0,+(1/0)];break;case"amount":case"payment":for(f=1,m=t(e.value);m>100-l;f*=10)m/=10;h=.001,u=f,c=[0,+(1/0)];break;case"rate":h=.001,u=t(e.value)>10?1:t(e.value)<1-.001*l?.01:.1,c=[0,10]}e.value=o(n(a,Math.max(c[0],Math.min(c[1],t(e.value)+u*l)).toFixed(2)-h)),s(),p.forEach(function(t){t!==r&&d[t].buttonsContainer.classList.contains("increment")&&d[t].calculate()})}}()),attach(d[r].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),attach(d[r].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!l(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),s()}),attach(d[r].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault(),13==(t.which||t.keyCode)&&d[r].calculate()}),attach(d[r].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),l(t.value)?t.value=o(n(r,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),attach(gei("toggle-year_month-input"),"change",function(){function t(){}gei("depreciation_schedule"),gei("toggle-year_month-input");return t(),t}())},A=a();for(_.id="dynamicStylesheet",qs("head").appendChild(_),x=0,L=C.length;L>x;x++)N(x);for(x in p)p.hop(x)&&k(x);if(0!==Object.keys(A).length&&A.constructor===Object){for(x in A)A.hop(x)&&(console.log(x),h[x]=A[x],d[x]&&(d[x].value.value=o(n("paymentYear"!=x?x:"payment",A[x]))));F=d[A.wasCalc],4===Object.keys(d).filter(function(t){return l(d[t].value.value)}).length&&(F&&F.value&&F.value.classList.add("calculated"),M(!0))}s();var T=!1,Y=!1,H=null,q=gei("graph_1-scroll_cursor"),O=gei("graph_1-scroll_bar");window.switchText=b})}();