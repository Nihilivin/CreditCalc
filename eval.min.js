/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
!function(){"use strict";function t(){var t,e,n,a,r=null,o=null;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},paymentYear:{get:function(){return r},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(r=t,o=t*e)}},paymentTotal:{get:function(){return o}}})}function e(t){return null===t||"undefined"==typeof t}function n(t,n,a){function r(t,e,n){t&&e&&n&&(t.addEventListener||t.attachEvent).call(t,e,n)}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,i=0,l=0,u=t.length,s=n.length,c=a.length;for(o=0;u>o;o++)for(i=0;s>i;i++)for(l=0;c>l;l++)r(t[o],n[i],a[l])}function a(t,n,a){function r(t,e,n){t&&e&&n&&(t.removeEventListener||t.detachEvent).call(t,e,n)}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,i=0,l=0,u=t.length,s=n.length,c=a.length;for(o=0;u>o;o++)for(i=0;s>i;i++)for(l=0;c>l;l++)r(t[o],n[i],a[l])}function r(t,n,a){function r(t,e,n,a){t&&e&&n&&(u.createEvent?(a=new Event(e),t.dispatchEvent(a)):(a=u.createEventObject(),t.fireEvent("on"+e,a)))}(e(t)||"Array"!==t.constructor.name)&&(t=[t]),(e(n)||"Array"!==n.constructor.name)&&(n=[n]),(e(a)||"Array"!==a.constructor.name)&&(a=[a]);var o=0,i=0,l=t.length,s=n.length;for(o=0;l>o;o++)for(i=0;s>i;i++)r(t[o],n[i],a)}function o(t){(e(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var n={};for(var a in t){var r="wasCalc"===a?s[t[a]]:t[a];n[s[a]||a]=r}var o=JSON.stringify(n),i=o.slice(1).slice(0,-1).replace(/"/g,""),l=h.convert(f,i);try{history.pushState?history.pushState(null,null,"#"+l):location.hash="#"+l}catch(u){console.error("Could not change hash:",u)}}function i(){var t,e=location.hash.slice(1),n={};try{t=f.convert(h,e),n=JSON.parse(("{"+t+"}").replace(/(\{|,)([^:]+)|([a-zA-Z]+)/g,'$1"$2$3"'))}catch(a){console.error(a,a.stack)}var r={};for(var o in n){var i="wasCalc"===c.filter(function(t){return s[t]==o})[0]?c.filter(function(t){return s[t]==n[o]})[0]:n[o];r[c.filter(function(t){return s[t]==o})[0]||o]=i}return r}var l=window,u=document;t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,n,a=this,r=new t,o=0,i=1,l=0;if(a.payment*(12*a.duration)<a.amount)return 0;for(r.duration=a.duration,r.payment=a.payment;i>1e-4&&999>=l;)l++,e=o,o+=i,r.rate=o,n=r.calc_amount(),n<a.amount?(i/=10,o=e):n===a.amout&&(l=1e3);return o},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}},l.isNA=e,l.attach=n,l.detach=a,l.triggerEvent=r;var s={amount:1,duration:2,rate:3,payment:4,paymentYear:5,wasCalc:9},c=Object.keys(s),f=new Base("!$&'()*+,;=-._~:@/?ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxyz0123456789"),h=new Base(":1234567890,.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ");l.gei=function(t){return u.getElementById(t)},l.qs=function(t,e){return(e||u).querySelector(t)},l.qsa=function(t,e){return(e||u).querySelectorAll(t)},l.geiN=function(t){return gei(t)||{}},l.qsN=function(t,e){return qs(t,e)||{}},l.qsaN=function(t,e){return qsa(t)||{}},l.hop=function(t,e){return t.hasOwnProperty(e)},l.timeoutUntil=function(t,e,n){setTimeout(function(){n()?t():timeoutUntil(t,e,n)},e)};var d,p={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},m=new t,y={},v={amount:0,duration:1,rate:2,payment:3},g={y:[],m:[]},w=gei("graph_1-body_scroll"),M=qs(".html-prototype",w),b=u.createElement("div");v=Object.keys(v),window.calculator=m,M.classList.remove("html-prototype"),b.appendChild(M),d=b.innerHTML,n(window,"load",function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function l(e,n){return n=t(n),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*n).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(n).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*n).toFixed(0))/100).toFixed(2):void 0}function s(t){t+="";var n,a=t.match(/^(\d*)(?:[.,](\d*))?$/),r=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(e(a)||0===a.length)return"";for(;a[1].match(r);)a[1]=a[1].replace(r,"$1 $2");if(n=a[1],!e(a[2])){for(n+=",";a[2].match(o);)a[2]=a[2].replace(o,"$1 $2");n+=a[2]}return n}function c(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function f(){var t,e=function(e){return e!==t&&c(y[e].value.value)};for(t in y)hop(y,t)&&(y[t].padlock.disabled=!c(y[t].value.value),y[t].calc.disabled=3!==Object.keys(y).filter(e).length)}function h(e){return y[e]&&y[e].value?(y[e].value.classList.remove("calculated"),t(y[e].value.value)):0}function M(t){for(var e=t.amount,n=1,a=[];Math.round(100*e)>0;){var r=t.amount,o=t.payment,i=t.rate,l=i/1200,u=l+1,s=-o,c=s/(1-u),f=Math.pow(u,n)*(r-c)+c;n++;var h={interests:e*l,loan:o-e*l,amountAtBegin:e,loanLeft:f};e=f,a.push(h)}return a}function b(t,e){return t=t.replace(/\{\s*([\w\.]+)\s*\}/g,function(t,n){var a=n.split("."),r=e,o=0,i=a.length;for(o;i>o&&(r="object"==typeof e?r[a[o]]:"",""!==r);o++);return r||""})}function L(t){if(document.createRange){var e,n=u.createRange();return n.selectNode(document.body),e=n.createContextualFragment(t),e.firstChild}var a=u.createElement("div");return a.innerHTML=t,a.firstChild}function x(t){function o(t,n){for(var a=M(t),r=0,o=a.length,i=n.getMonth(),l=n.getFullYear(),u=l,s={};o>r&&l+y+1>u;r++){if(i++,i>11||r===o-1){for(var c in s[u])s[u].hasOwnProperty(c)&&(e(s[u].loan)&&(s[u].loan=0),s[u].loan+=s[u][c].loan,e(s[u].interests)&&(s[u].interests=0),s[u].interests+=s[u][c].interests);s[u].loanLeft=a[r===o-1?r:r-1].loanLeft}i>11&&(i=0,u++),e(s[u])&&(s[u]={}),s[u][i+1]=a[r]}return s}function i(t,e){e=[].slice.call(e);for(var n=0,a=e.length,r=0;a>r;r++){var o=qs(t,e[r]);o&&(n=Math.max(o.offsetWidth,n))}return n}for(var u,c=m,f=new Date,f=new Date(f.getFullYear(),f.getMonth()+1),h=new Date(f.getFullYear()+Math.floor(c.duration),f.getMonth()+Math.round(c.duration%1*12)),y=15,v=o(c,f),x=f.getFullYear(),C={y:{},m:{}},k=0;y>k&&!e(u=v[x+k]);k++)C.y[String(x+k)]={loanLeft:u.loanLeft,loan:u.loan,interests:u.interests};for(var q,A,k=-1,T=f.getMonth(),Y=0;++k<y&&!e(q=v[x+Y])&&!e(A=q[T+1]);)console.log(T,k,A),C.m[k+"_"+p[T+1]["short"]+" "+(x+Y)]={loanLeft:A.loanLeft,loan:A.loan,interests:A.interests},T++,12==T&&(Y++,T=0);F(gei("datestart"),p[f.getMonth()+1].full+" "+f.getFullYear(),t),F(gei("dateend"),p[h.getMonth()+1].full+" "+h.getFullYear(),t),F(gei("refund_amount"),s(l("roundMoney",c.paymentTotal)),t),F(gei("payback_amount"),s(l("roundMoney",c.amount)),t),F(gei("interests_amount"),s(l("roundMoney",c.paymentTotal-c.amount)),t);for(var O=0,j=Object.keys(C.y),H=j.length;H>O;O++){var $=j[O],J=C.y[$],W=function(){return $==f.getFullYear()&&$==h.getFullYear()?h.getMonth()-f.getMonth():$==f.getFullYear()?12-f.getMonth():$==h.getFullYear()?h.getMonth()+1:12}()/12;if(e(g.y[O])){var D=b(d,{type:"year",label:$,payment:s(l("roundMoney",c.paymentYear*W))+" €",loan_paid:s(l("roundMoney",J.loan))+"€",loan_width:l("roundMoney",J.loan)/(12*c.payment)*100+"%",interests_paid:s(l("roundMoney",J.interests))+"€",interests_width:l("roundMoney",J.interests)/(12*c.payment)*100+"%"}),z=L(D);g.y.push(z),w.appendChild(z),z.classList.add("inside"),O===H-1&&z.classList.add("last")}else g.y[O].classList.add("inside"),O===H-1?g.y[O].classList.add("last"):g.y[O].classList.remove("last"),qsN(".date p",g.y[O]).innerHTML=$,qsN(".payment p",g.y[O]).innerHTML=s(l("roundMoney",c.paymentYear*W))+" €",qsN(".refund p",g.y[O]).innerHTML=s(l("roundMoney",J.loan))+"€",qsN(".interests p",g.y[O]).innerHTML=s(l("roundMoney",J.interests))+"€"}for(;y>O;O++){var B=g.y[O];e(B)||(B.classList.remove("inside"),B.classList.remove("last"))}var V=gei("graph_1_head"),U=V.offsetWidth,P=0,R=25,I=qs(".line-year .date",w),G=qs("p",I);timeoutUntil(function(){function t(t){S=!0,U=V.offsetWidth,P=0;for(var n=U-(h+40),a=Math.max(f,n/(m+1)),r=Math.max(s,Math.min(n-a,n/(m+1)*m)),i=a,l=U-i,u=Math.max(d/r,p/a),y=qs(".refund .graph-elem",V),g=qs(".interests .graph-elem",V),w=Math.max(c.amount/r,(c.paymentTotal-c.amount)/a),M=0;H>M;M++){var b=C.y[j[M]];if(!e(b)){var L=o[M],x=qs(".refund .graph-elem",L),F=qs(".interests .graph-elem",L);x.style.width=b.loan/u+"px",F.style.width=b.interests/u+"px"}}_.innerHTML=v+"#graph_1 .left{min-width:"+l+"px;max-width:"+l+"px;width:"+l+"px;}\n#graph_1 .right{min-width:"+i+"px;max-width:"+i+"px;width:"+i+"px;}\n",y.style.width=c.amount/w+"px",g.style.width=(c.paymentTotal-c.amount)/w+"px"}var o=qsa(".line-year",w),l=i(".date",o),u=i(".payment",o),s=i(".refund p",o),f=i(".interests p",o),h=l+u,d=Math.max.apply(null,Object.keys(C.y).map(function(t){return C.y[t].loan})),p=Math.max.apply(null,Object.keys(C.y).map(function(t){return C.y[t].interests})),m=d/p,y=(c.amount/(c.paymentTotal-c.amount),"#graph_1 .graph_1-line.line-year "),v=y+".date{width:"+l+"px}\n"+y+".payment{width:"+u+"px}\n"+y+".refund{min-width:"+s+"px;flex:"+m+" 0 0}\n"+y+".interests{min-width:"+f+"px;flex:1 0 0}\n";_.innerHTML=v,E?(a(window,"resize",N),N=t,n(window,"resize",N)):(E=!0,N=t,n(window,"resize",N)),r(window,"resize")},10,function(){return I.offsetWidth==G.offsetWidth+10||S&&++P>R})}function F(t,n,a){function r(){var e=o.offsetWidth;t.classList.remove("prepare"),t.classList.add("doing"),t.style.width=e+"px",t.style.height=o.offsetHeight+"px",setTimeout(function(){t.removeChild(t.lastChild),t.classList.remove("doing"),t.style.width=""},500)}if(a=a===!0,!e(t)){if(a)return void(t.innerHTML="<span>"+n+"</span>");var o=L("<span>"+n+"</span>");t.style.height=t.firstChild.offsetHeight+"px",t.style.width=t.firstChild.offsetWidth+"px",t.classList.add("prepare"),t.insertBefore(o,t.firstChild),timeoutUntil(r,10,function(){return 0!==o.offsetWidth||0!=n.length})}}var C,k,q,_=u.createElement("style"),A=qsa("button.repeatable"),T=function(t){var e,a,o,i=A[t],l=i.getAttribute("data-timer-basestep")||500;n(i,"mousedown",function(){o++,a=l/(Math.log(Math.pow(o,2))+1),e=setTimeout(function(){r(i,"mousedown")},a)}),n([i,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),a=l,o=0}),r(i,"mouseup")},Y=function(e){var a=v[e];y[a]={calc:gei(a+"-button"),value:gei(a+"-value"),buttonsContainer:gei(a+"-buttons-plus-minus-container"),padlock:gei(a+"-padlock"),plus:gei(a+"-plus"),minus:gei(a+"-minus")},y[a].value.setAttribute("data-placeholder",y[a].value.placeholder),y[a].calculate=function(){var t=v.filter(function(t){return t!==a}),e=a;return function(){var n,a,r=m,i=y[e].value;for(n in t)hop(t,n)&&(r[t[n]]=h(t[n]));a=r["calc_"+e](),"payment"===e?r.paymentYear=12*a:r.paymentYear=r.payment,r[e]=a,i.value=s(l(e,a)),o({amount:parseFloat(l("amount",r.amount)),duration:parseFloat(l("duration",r.duration)),rate:parseFloat(l("rate",r.rate)),payment:parseFloat(l("payment",r.payment)),paymentYear:parseFloat(l("payment",r.paymentYear)),wasCalc:e}),i.classList.add("calculated"),f(),x()}}(),n(y[a].calc,"click",y[a].calculate),n([y[a].padlock],"click",function(){var t=y[a].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===v.filter(function(t){return y[t].buttonsContainer.classList.contains("locked")}).length;v.forEach(function(t){var n=y[t].buttonsContainer;n.classList.contains("locked")||e!==!0?n.classList.remove("increment"):n.classList.add("increment")})}}()),n([y[a].plus,y[a].minus],"mousedown",function(){var e=y[a].value,n=a;return function(r){var o,i,u,c,h,d;switch(o=r.target.id===n+"-plus"?1:r.target.id===n+"-minus"?-1:0,n){case"duration":c=-.001,i=1,u=[0,+(1/0)];break;case"amount":case"payment":for(h=1,d=t(e.value);d>100-o;h*=10)d/=10;c=.001,i=h,u=[0,+(1/0)];break;case"rate":c=.001,i=t(e.value)>10?1:t(e.value)<1-.001*o?.01:.1,u=[0,10]}e.value=s(l(n,Math.max(u[0],Math.min(u[1],t(e.value)+i*o)).toFixed(2)-c)),f(),v.forEach(function(t){t!==a&&y[t].buttonsContainer.classList.contains("increment")&&y[t].calculate()})}}()),n(y[a].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),n(y[a].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!c(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),f()}),n(y[a].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault(),13==(t.which||t.keyCode)&&y[a].calculate()}),n(y[a].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),c(t.value)?t.value=s(l(a,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),n(gei("toggle-year_month-input"),"change",function(){function t(){}gei("depreciation_schedule"),gei("toggle-year_month-input");return t(),t}())},O=i();for(_.id="dynamicStylesheet",qs("head").appendChild(_),C=0,k=A.length;k>C;C++)T(C);for(C in v)hop(v,C)&&Y(C);if(0!==Object.keys(O).length&&O.constructor===Object){for(C in O)hop(O,C)&&(m[C]=O[C],y[C]&&(y[C].value.value=s(l("paymentYear"!=C?C:"payment",O[C]))));q=y[O.wasCalc],4===Object.keys(y).filter(function(t){return c(y[t].value.value)}).length&&(q&&q.value&&q.value.classList.add("calculated"),x(!0))}f();var E=!1,S=!1,N=null;window.switchText=F})}();