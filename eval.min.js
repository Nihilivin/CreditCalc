/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.1.0
 */
"use strict";function Calculator(){var e,t,a,r;Object.defineProperties(this,{amount:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},rate:{get:function(){return a},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(a=e)}},duration:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},payment:{get:function(){return r},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(r=e)}}})}function attach(e,t,a){function r(e,t,a){e&&t&&a&&(e.addEventListener?e.addEventListener(t,a):e.attachEvent(t,a))}null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var l=0,n=0,u=0,o=e.length,i=t.length,c=a.length;for(l=0;o>l;l++)for(n=0;i>n;n++)for(u=0;c>u;u++)r(e[l],t[n],a[u])}function detach(e,t,a){function r(e,t,a){e&&t&&a&&(e.removeEventListener?e.removeEventListener(t,a):e.detachEvent(t,a))}null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var l=0,n=0,u=0,o=e.length,i=t.length,c=a.length;for(l=0;o>l;l++)for(n=0;i>n;n++)for(u=0;c>u;u++)r(e[l],t[n],a[u])}function gei(e){return document.getElementById(e)}function setButtonsToDefaultColor(){}function formatDisplayable(e){e+="";var t=e.match(/^(\d*)(?:[.,](\d*))?$/);console.log(e,t);for(var a=/(.*\d)(\d{3})/;t[1].match(a);)t[1]=t[1].replace(a,"$1 $2");var r=t[1];if("undefined"!=typeof t[2]){var l=/(\d{3})(.*\d)/;for(r+=",";t[2].match(l);)t[2]=t[2].replace(l,"$1 $2");r+=t[2]}return r}function preciseValue(e,t){return t=getNumFieldValue(t),-1!=["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*t).toFixed(0))/100).toFixed(2):"duration"==e?Math.floor(t).toFixed(0):void 0}function enableCalcButtons(){for(var e in formElems)formElems[e].calc.disabled=3!=Object.keys(formElems).filter(function(t){return t!=e&&isParsableNumber(formElems[t].value.value)}).length;gei("pager-button-1_2").disabled=4!=Object.keys(formElems).filter(function(e){return isParsableNumber(formElems[e].value.value)}).length}function isParsableNumber(e){return e.length>0?!(e.match(/[^0-9,. ]/)||(e.match(/[.,]/g)||[]).length>1||!e.match(/^\d/)||!e.match(/\d$/)):!1}function getVarValue(e){return formElems[e]&&formElems[e].value?(formElems[e].value.classList.remove("calculated"),getNumFieldValue(formElems[e].value.value)):0}function getNumFieldValue(e){return parseFloat((e+"").replace(/ /g,"").replace(/,/g,".")||0)}Calculator.prototype={calc_amount:function(){var e=this.rate/1200;return this.payment*((1-1/Math.pow(1+e,12*this.duration))/e)},calc_duration:function(){var e=this.rate/1200;return Math.log(-this.payment/(e*this.amount-this.payment))/(12*Math.log(e+1))},calc_rate:function(){if(this.payment*(12*this.duration)<this.amount)return console.log("No interest"),0;var e,t=new Calculator,a=0,r=1,l=0;for(t.duration=this.duration,t.payment=this.payment;r>1e-4&&999>=l;){l++,e=a,a+=r,t.rate=a;var n=t.calc_amount();console.log("Checking with:",{rate:a,step:r}),n<this.amount?(r/=10,a=e):n==this.amout&&(l=1e3)}return a},calc_payment:function(){var e=this.rate/1200;return this.amount*e/(1-1/Math.pow(1+e,12*this.duration))}};var calculator=new Calculator,formElems={},calculatorVariables={amount:0,duration:1,rate:2,payment:3};calculatorVariables=Object.keys(calculatorVariables);for(var i in calculatorVariables)!function(){var e=calculatorVariables[i];formElems[e]={calc:gei(e+"-button"),value:gei(e+"-value"),minus:gei(e+"-minus"),plus:gei(e+"-plus")},formElems[e].value.setAttribute("data-placeholder",formElems[e].value.placeholder),attach(formElems[e].calc,"click",function(){var t=calculatorVariables.filter(function(t){return t!=e}),a=e;return function(){for(var e in t)calculator[t[e]]=getVarValue(t[e]);console.log(calculator);var r=calculator["calc_"+a](),l=formElems[a].value;console.log(r),l.value=formatDisplayable(preciseValue(a,r)),l.classList.add("calculated"),enableCalcButtons()}}()),attach([formElems[e].plus,formElems[e].minus],"click",function(){var t=formElems[e].value,a=e;return function(e){var r;r=e.target.id==a+"-plus"?1:e.target.id==a+"-minus"?-1:0;var l,n;switch(a){case"duration":l=1,n=[0,+(1/0)];break;case"amount":case"payment":for(var u=1,o=getNumFieldValue(t.value);o>100-r;u*=10,o/=10);l=u,n=[0,+(1/0)];break;case"rate":l=.1,n=[1,10]}t.value=formatDisplayable(Math.max(n[0],Math.min(n[1],preciseValue(a,getNumFieldValue(t.value)+l*r))))}}()),attach(formElems[e].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),attach(formElems[e].value,["blur","keyup","change","input"],function(){var e=this,t=e.value.trim();e.placeholder=e.getAttribute("data-placeholder"),!isParsableNumber(t)&&t.length>0?e.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):e.setCustomValidity(""),enableCalcButtons()}),attach(formElems[e].value,"blur",function(){isParsableNumber(this.value)?this.value=formatDisplayable(preciseValue(e,this.value)):""==this.value?this.setCustomValidity(""):this.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")})}();enableCalcButtons(),console.log(formElems),attach([].slice.call(document.querySelectorAll(".pager-button")),"click",function(){var e=document.querySelector("body");return function(t){e.setAttribute("data-page",this.getAttribute("data-page-target"))}}());