/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.2.0
 */
!function(){"use strict";function t(){var t,e,n,a,o=null,r=null;Object.defineProperties(this,{amount:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},rate:{get:function(){return n},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(n=t)}},duration:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},payment:{get:function(){return a},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(a=t)}},paymentYear:{get:function(){return o},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(o=t,r=t*e)}},paymentTotal:{get:function(){return r}}})}function e(t){(isNA(t)||""===t)&&(history.pushState?history.pushState(null,null,""):location.hash="");var e={};for(var n in t){var a="wasCalc"===n?i[t[n]]:t[n];e[i[n]||n]=a}var o=JSON.stringify(e),r=o.slice(1).slice(0,-1).replace(/"/g,""),l=u.convert(s,r);try{history.pushState?history.pushState(null,null,"#"+l):location.hash="#"+l}catch(c){console.error("Could not change hash:",c)}}function n(){var t,e=location.hash.slice(1),n={};try{t=s.convert(u,e),n=JSON.parse(("{"+t+"}").replace(/(\{|,)([^:]+)|([a-zA-Z]+)/g,'$1"$2$3"'))}catch(a){console.error(a,a.stack)}var o={};for(var r in n){var c="wasCalc"===l.filter(function(t){return i[t]==r})[0]?l.filter(function(t){return i[t]==n[r]})[0]:n[r];o[l.filter(function(t){return i[t]==r})[0]||r]=c}return o}var a=window,o=document;t.prototype={calc_amount:function(){var t=this,e=t.rate/1200;return t.payment*((1-1/Math.pow(1+e,12*t.duration))/e)},calc_duration:function(){var t=this,e=t.rate/1200;return Math.log(-t.payment/(e*t.amount-t.payment))/(12*Math.log(e+1))},calc_rate:function(){var e,n,a=this,o=new t,r=0,i=1,l=0;if(a.payment*(12*a.duration)<a.amount)return 0;for(o.duration=a.duration,o.payment=a.payment;i>1e-4&&999>=l;)l++,e=r,r+=i,o.rate=r,n=o.calc_amount(),n<a.amount?(i/=10,r=e):n===a.amout&&(l=1e3);return r},calc_payment:function(){var t=this,e=t.rate/1200;return t.amount*e/(1-1/Math.pow(1+e,12*t.duration))}};var r,i={amount:1,duration:2,rate:3,payment:4,paymentYear:5,wasCalc:9},l=Object.keys(i),s=new Base("!$&'()*+,;=-._~:@/?ABCDEFGHIJKLMNOPQRSTUVWXYabcdefghijklmnopqrstuvwxyz0123456789"),u=new Base(":1234567890,.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),c={1:{full:"Janvier","short":"Janv."},2:{full:"Février","short":"Févr."},3:{full:"Mars","short":"Mars"},4:{full:"Avril","short":"Avr."},5:{full:"Mai","short":"Mai"},6:{full:"Juin","short":"Juin"},7:{full:"Juillet","short":"Juil."},8:{full:"Aout","short":"Aout"},9:{full:"Septembre","short":"Sept."},10:{full:"Octobre","short":"Oct."},11:{full:"Novembre","short":"Nov."},12:{full:"Décembre","short":"Déc."}},f=new t,h={},p={amount:0,duration:1,rate:2,payment:3},d={y:[],m:[]},m=gei("graph_1-body_scroll"),g=gei("graph_1-body_scroll-container-years"),y=qs(".html-prototype",m),v=o.createElement("div");a.formElems=h,p=Object.keys(p),window.calculator=f,y.classList.remove("html-prototype"),v.appendChild(y),r=v.innerHTML,on(window,"load",function(){function t(t){return parseFloat(String(t).replace(/ /g,"").replace(/,/g,".")||0)}function a(e,n){return n=t(n),-1!==["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*n).toFixed(0))/100).toFixed(2):"duration"===e?Math.ceil(n).toFixed(0):"roundMoney"===e?(parseFloat(Math.round(100*n).toFixed(0))/100).toFixed(2):void 0}function i(t){t+="";var e,n=t.match(/^(\d*)(?:[.,](\d*))?$/),a=/(.*\d)(\d{3})/,o=/(\d{3})(.*\d)/;if(isNA(n)||0===n.length)return"";for(;n[1].match(a);)n[1]=n[1].replace(a,"$1 $2");if(e=n[1],!isNA(n[2])){for(e+=",";n[2].match(o);)n[2]=n[2].replace(o,"$1 $2");e+=n[2]}return e}function l(t){return t.length>0?!(t.match(/[^0-9,. ]/)||(t.match(/[.,]/g)||[]).length>1||!t.match(/^\d/)||!t.match(/\d$/)):!1}function s(){var t,e=function(e){return e!==t&&l(h[e].value.value)};for(t in h)hop(h,t)&&(h[t].padlock.disabled=!l(h[t].value.value),h[t].calc.disabled=3!==Object.keys(h).filter(e).length)}function u(e){return h[e]&&h[e].value?(h[e].value.classList.remove("calculated"),t(h[e].value.value)):0}function y(t){for(var e=t.amount,n=1,a=[];Math.round(100*e)>0;){var o=t.amount,r=t.payment,i=t.rate,l=i/1200,s=l+1,u=-r,c=u/(1-s),f=Math.pow(s,n)*(o-c)+c;n++;var h={interests:e*l,loan:r-e*l,amountAtBegin:e,loanLeft:f};e=f,a.push(h)}return a}function v(t,e){return t=t.replace(/\{\s*([\w\.]+)\s*\}/g,function(t,n){var a=n.split("."),o=e,r=0,i=a.length;for(r;i>r&&(o="object"==typeof e?o[a[r]]:"",""!==o);r++);return o||""})}function M(t){if(document.createRange){var e,n=o.createRange();return n.selectNode(document.body),e=n.createContextualFragment(t),e.firstChild}var a=o.createElement("div");return a.innerHTML=t,a.firstChild}function w(t){function e(t,e){for(var n=y(t),a=0,o=n.length,r=e.getMonth(),i=e.getFullYear(),l=i,s={};o>a&&i+h+1>l;a++){if(r++,r>11||a===o-1){for(var u in s[l])hop(s[l],u)&&(isNA(s[l].loan)&&(s[l].loan=0),s[l].loan+=s[l][u].loan,isNA(s[l].interests)&&(s[l].interests=0),s[l].interests+=s[l][u].interests);s[l].loanLeft=n[a===o-1?a:a-1].loanLeft}r>11&&(r=0,l++),isNA(s[l])&&(s[l]={}),s[l][r+1]=n[a]}return s}function n(t,e){e=[].slice.call(e);for(var n=0,a=e.length,o=0;a>o;o++){var r=qs(t,e[o]);r&&(n=Math.max(r.offsetWidth,n))}return n}clearInterval(Y);for(var o,l=f,s=new Date,s=new Date(s.getFullYear(),s.getMonth()+1),u=new Date(s.getFullYear()+Math.floor(l.duration),s.getMonth()+Math.round(l.duration%1*12)),h=15,p=e(l,s),m=s.getFullYear(),w={y:{},m:{}},x=0;h>x&&!isNA(o=p[m+x]);x++)w.y[String(m+x)]={loanLeft:o.loanLeft,loan:o.loan,interests:o.interests};for(var _,L,x=-1,F=s.getMonth(),C=0;++x<h&&!isNA(_=p[m+C])&&!isNA(L=_[F+1]);)console.log(F,x,L),w.m[x+"_"+c[F+1]["short"]+" "+(m+C)]={loanLeft:L.loanLeft,loan:L.loan,interests:L.interests},F++,12==F&&(C++,F=0);b(gei("datestart"),c[s.getMonth()+1].full+" "+s.getFullYear(),t),b(gei("dateend"),c[u.getMonth()+1].full+" "+u.getFullYear(),t),b(gei("refund_amount"),i(a("roundMoney",l.paymentTotal)),t),b(gei("payback_amount"),i(a("roundMoney",l.amount)),t),b(gei("interests_amount"),i(a("roundMoney",l.paymentTotal-l.amount)),t);for(var T=0,k=Object.keys(w.y),A=k.length;A>T;T++){var H=k[T],W=w.y[H],D=function(){return H==s.getFullYear()&&H==u.getFullYear()?u.getMonth()-s.getMonth():H==s.getFullYear()?12-s.getMonth():H==u.getFullYear()?u.getMonth()+1:12}()/12;if(isNA(d.y[T])){var E=v(r,{type:"year",label:H,payment:i(a("roundMoney",l.paymentYear*D))+" €",loan_paid:i(a("roundMoney",W.loan))+"€",loan_width:a("roundMoney",W.loan)/(12*l.payment)*100+"%",interests_paid:i(a("roundMoney",W.interests))+"€",interests_width:a("roundMoney",W.interests)/(12*l.payment)*100+"%"}),I=M(E);d.y.push(I),g.appendChild(I),I.classList.add("inside"),T===A-1&&I.classList.add("last")}else d.y[T].classList.add("inside"),T===A-1?d.y[T].classList.add("last"):d.y[T].classList.remove("last"),qsN(".date p",d.y[T]).innerHTML=H,qsN(".payment p",d.y[T]).innerHTML=i(a("roundMoney",l.paymentYear*D))+" €",qsN(".refund p",d.y[T]).innerHTML=i(a("roundMoney",W.loan))+"€",qsN(".interests p",d.y[T]).innerHTML=i(a("roundMoney",W.interests))+"€"}for(;h>T;T++){var V=d.y[T];isNA(V)||(V.classList.remove("inside"),V.classList.remove("last"))}var z=gei("graph_1_head"),B=z.offsetWidth,P=0,R=qs(".line-year .date",g),U=qs("p",R);waitUntil(function(){function t(t){clearTimeout(q),q=setTimeout(function(){e(t)},100)}function e(t){S=!0,B=z.offsetWidth,P=0;for(var e=B-(u+40),n=Math.max(s,e/(h+1)),o=Math.max(i,Math.min(e-n,e/(h+1)*h)),r=n,p=Math.max(c/o,f/n),m=qs(".refund .graph-elem",z),g=qs(".interests .graph-elem",z),y=Math.max(l.amount/o,(l.paymentTotal-l.amount)/n),v=0;A>v;v++){var M=w.y[k[v]];if(!isNA(M)){var b=a[v],x=qs(".refund .graph-elem",b),_=qs(".interests .graph-elem",b);x.style.width=M.loan/p+"px",_.style.width=M.interests/p+"px"}}N.innerHTML=d+"#graph_1 .right{min-width:"+r+"px;max-width:"+r+"px;width:"+r+"px;}\n#graph_1-padder{min-height:"+geiN("calculator-padder").offsetHeight+"px;max-height:"+geiN("basic_data").offsetHeight+"px;height:"+docHeight()+"px;}",m.style.width=l.amount/y+"px",g.style.width=(l.paymentTotal-l.amount)/y+"px";var L=qsN("#graph_1-body_scroll-container-years .graph_1-line.inside"),F=qsN("#graph_1-body_scroll-container-years .graph_1-line.inside.last"),C=F.offsetTop+50-L.offsetTop,T=geiN("graph_1-scroll_area");(T.style||{}).maxHeight=C+"px",setTimeout(function(){clearInterval(Y)},500),clearInterval(Y),Y=setInterval(function(){var t=(T.offsetHeight-10)/C*J.offsetHeight;$.style.height=t+"px",$.style.top=Math.min(J.offsetHeight-10-t,$.offsetTop)},100)}var a=qsa(".line-year",g),o=n(".date",a),r=n(".payment",a),i=n(".refund p",a),s=n(".interests p",a),u=o+r,c=Math.max.apply(null,Object.keys(w.y).map(function(t){return w.y[t].loan})),f=Math.max.apply(null,Object.keys(w.y).map(function(t){return w.y[t].interests})),h=c/f,p=(l.amount/(l.paymentTotal-l.amount),"#graph_1 .graph_1-line.line-year "),d=p+".date{width:"+o+"px}\n"+p+".payment{width:"+r+"px}\n"+p+".refund{min-width:"+i+"px;flex:"+h+" 0 0}\n"+p+".interests{min-width:"+s+"px;flex:1 0 0}\n";N.innerHTML=d,O?off(window,"resize",j):O=!0,clearInterval(Y),j=t,on(window,"resize",j),go(window,"resize")},function(){return R.offsetWidth==U.offsetWidth+10},100,S?250:!1)}function b(t,e,n){function a(){var e=o.offsetWidth;t.classList.remove("prepare"),t.classList.add("doing"),t.style.width=e+"px",t.style.height=o.offsetHeight+"px",setTimeout(function(){t.removeChild(t.lastChild),t.classList.remove("doing"),t.style.width=""},500)}if(n=n===!0,!isNA(t)){if(n)return void(t.innerHTML="<span>"+e+"</span>");var o=M("<span>"+e+"</span>");t.style.height=t.firstChild.offsetHeight+"px",t.style.width=t.firstChild.offsetWidth+"px",t.classList.add("prepare"),t.insertBefore(o,t.firstChild),waitUntil(a,function(){return 0!==o.offsetWidth||0!=e.length},10)}}function x(t){if(_(t),W!==!1&&1&t.buttons){var e=J.offsetHeight-$.offsetHeight-10,n=Math.min(e,Math.max(0,t.pageY-J.offsetTop-W));$.style.top=n+"px",D.style.top="-"+(D.offsetHeight-m.offsetHeight)*(n/e)+"px"}}function _(t){t.stopPropagation(),t.preventDefault()}var L,F,C,N=o.createElement("style"),T=qsa("button.repeatable"),k=function(t){var e,n,a,o=T[t],r=o.getAttribute("data-timer-basestep")||500;on(o,"mousedown",function(){a++,n=r/(Math.log(Math.pow(a,2))+1),e=setTimeout(function(){go(o,"mousedown")},n)}),on([o,window],["mouseup","mouseleave","blur"],function(){clearTimeout(e),n=r,a=0}),go(o,"mouseup")},A=function(n){var o=p[n];h[o]={calc:gei(o+"-button"),value:gei(o+"-value"),buttonsContainer:gei(o+"-buttons-plus-minus-container"),padlock:gei(o+"-padlock"),plus:gei(o+"-plus"),minus:gei(o+"-minus")},h[o].value.setAttribute("data-placeholder",h[o].value.placeholder),h[o].calculate=function(){var t=p.filter(function(t){return t!==o}),n=o;return function(){var o,r,l=f,c=h[n].value;for(o in t)hop(t,o)&&(l[t[o]]=u(t[o]));r=l["calc_"+n](),"payment"===n?l.paymentYear=12*r:l.paymentYear=l.payment,l[n]=r,c.value=i(a(n,r)),e({amount:parseFloat(a("amount",l.amount)),duration:parseFloat(a("duration",l.duration)),rate:parseFloat(a("rate",l.rate)),payment:parseFloat(a("payment",l.payment)),paymentYear:parseFloat(a("payment",l.paymentYear)),wasCalc:n}),c.classList.add("calculated"),s(),w()}}(),on(h[o].calc,"click",h[o].calculate),on([h[o].padlock],"click",function(){var t=h[o].buttonsContainer;return function(){t.classList.toggle("locked");var e=2===p.filter(function(t){return h[t].buttonsContainer.classList.contains("locked")}).length;p.forEach(function(t){var n=h[t].buttonsContainer;n.classList.contains("locked")||e!==!0?n.classList.remove("increment"):n.classList.add("increment")})}}()),on([h[o].plus,h[o].minus],"mousedown",function(){var e=h[o].value,n=o;return function(r){var l,u,c,f,d,m;switch(l=r.target.id===n+"-plus"?1:r.target.id===n+"-minus"?-1:0,n){case"duration":f=-.001,u=1,c=[0,+(1/0)];break;case"amount":case"payment":for(d=1,m=t(e.value);m>100-l;d*=10)m/=10;f=.001,u=d,c=[0,+(1/0)];break;case"rate":f=.001,u=t(e.value)>10?1:t(e.value)<1-.001*l?.01:.1,c=[0,10]}e.value=i(a(n,Math.max(c[0],Math.min(c[1],t(e.value)+u*l)).toFixed(2)-f)),s(),p.forEach(function(t){t!==o&&h[t].buttonsContainer.classList.contains("increment")&&h[t].calculate()})}}()),on(h[o].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),on(h[o].value,["blur","keyup","change","input"],function(){var t=this,e=t.value.trim();!l(e)&&e.length>0?t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):t.setCustomValidity(""),s()}),on(h[o].value,"keypress",function(t){String.fromCharCode(t.which||t.keyCode).match(/^[0-9,. ]$/)||t.preventDefault(),13==(t.which||t.keyCode)&&h[o].calculate()}),on(h[o].value,"blur",function(){var t=this;t.placeholder=t.getAttribute("data-placeholder"),l(t.value)?t.value=i(a(o,t.value)):""===t.value?t.setCustomValidity(""):t.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),on(gei("toggle-year_month-input"),"change",function(){function t(){}gei("depreciation_schedule"),gei("toggle-year_month-input");return t(),t}())},H=n();for(N.id="dynamicStylesheet",document.head.appendChild(N),L=0,F=T.length;F>L;L++)k(L);for(L in p)hop(p,L)&&A(L);if(0!==Object.keys(H).length&&H.constructor===Object){for(L in H)hop(H,L)&&(console.log(L),f[L]=H[L],h[L]&&(h[L].value.value=i(a("paymentYear"!=L?L:"payment",H[L]))));C=h[H.wasCalc],4===Object.keys(h).filter(function(t){return l(h[t].value.value)}).length&&(C&&C.value&&C.value.classList.add("calculated"),w(!0))}s();var Y,q,O=!1,S=!1,j=null,$=gei("graph_1-scroll_cursor"),J=gei("graph_1-scroll_bar");window.switchText=b;var W=!1,D=gei("graph_1-body_scroll-container");on($,"mousedown",function(t){_(t),1&t.buttons&&(on(o,"mousemove",x),W=t.offsetY)}),on(document,"mouseup",function(t){W!==!1&&(_(t),1&t.buttons||(off(o,"mousemove",x),W=!1))}),on($,"contextmenu",function(t){return _(t),!1})})}();