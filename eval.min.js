/**
 * @file Main calculator client-side script
 *
 * @author Alexandre Germain
 * @copyright 2016 GerkinDevelopment
 * @license none none
 * @package creditcalc
 *
 * @version 0.1.0
 */
"use strict";function Calculator(){var e,t,a,n;Object.defineProperties(this,{amount:{get:function(){return e},set:function(t){t=parseFloat(t),isFinite(t)&&t>0&&(e=t)}},rate:{get:function(){return a},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(a=e)}},duration:{get:function(){return t},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(t=e)}},payment:{get:function(){return n},set:function(e){e=parseFloat(e),isFinite(e)&&e>0&&(n=e)}}})}function attach(e,t,a){function n(e,t,a){e&&t&&a&&(e.addEventListener?e.addEventListener(t,a):e.attachEvent(t,a))}null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var r=0,l=0,o=0,u=e.length,i=t.length,c=a.length;for(r=0;u>r;r++)for(l=0;i>l;l++)for(o=0;c>o;o++)n(e[r],t[l],a[o])}function detach(e,t,a){function n(e,t,a){e&&t&&a&&(e.removeEventListener?e.removeEventListener(t,a):e.detachEvent(t,a))}null!=e&&"undefined"!=typeof e&&"Array"==e.constructor.name||(e=[e]),null!=t&&"undefined"!=typeof t&&"Array"==t.constructor.name||(t=[t]),null!=a&&"undefined"!=typeof a&&"Array"==a.constructor.name||(a=[a]);var r=0,l=0,o=0,u=e.length,i=t.length,c=a.length;for(r=0;u>r;r++)for(l=0;i>l;l++)for(o=0;c>o;o++)n(e[r],t[l],a[o])}function gei(e){return document.getElementById(e)}function setUrlHash(e){var t=JSON.stringify(e),a=btoa(t);history.pushState?history.pushState(null,null,"#"+a):location.hash="#"+a}function getUrlHash(){var e=location.hash.replace(/^#/,""),t={};try{t=JSON.parse(atob(e))}catch(a){}return t}gei("amount-value").value=1e5,gei("duration-value").value=15,gei("rate-value").value=5,Calculator.prototype={calc_amount:function(){var e=this,t=e.rate/1200;return e.payment*((1-1/Math.pow(1+t,12*e.duration))/t)},calc_duration:function(){var e=this,t=e.rate/1200;return Math.log(-e.payment/(t*e.amount-e.payment))/(12*Math.log(t+1))},calc_rate:function(){var e,t=this,a=new Calculator,n=0,r=1,l=0;if(t.payment*(12*t.duration)<t.amount)return 0;for(a.duration=t.duration,a.payment=t.payment;r>1e-4&&999>=l;){l++,e=n,n+=r,a.rate=n;var o=a.calc_amount();o<t.amount?(r/=10,n=e):o==t.amout&&(l=1e3)}return n},calc_payment:function(){var e=this,t=e.rate/1200;return e.amount*t/(1-1/Math.pow(1+t,12*e.duration))}};var calculator=new Calculator,formElems={},calculatorVariables={amount:0,duration:1,rate:2,payment:3};calculatorVariables=Object.keys(calculatorVariables),function(){function e(e,t){return t=l(t),-1!=["amount","payment","rate"].indexOf(e)?(parseFloat(Math.ceil(100*t).toFixed(0))/100).toFixed(2):"duration"==e?Math.floor(t).toFixed(0):void 0}function t(e){e+="";for(var t=e.match(/^(\d*)(?:[.,](\d*))?$/),a=/(.*\d)(\d{3})/;t[1].match(a);)t[1]=t[1].replace(a,"$1 $2");var n=t[1];if("undefined"!=typeof t[2]){var r=/(\d{3})(.*\d)/;for(n+=",";t[2].match(r);)t[2]=t[2].replace(r,"$1 $2");n+=t[2]}return n}function a(){for(var e in formElems)formElems[e].calc.disabled=3!=Object.keys(formElems).filter(function(t){return t!=e&&n(formElems[t].value.value)}).length;gei("pager-button-1_2").disabled=4!=Object.keys(formElems).filter(function(e){return n(formElems[e].value.value)}).length}function n(e){return e.length>0?!(e.match(/[^0-9,. ]/)||(e.match(/[.,]/g)||[]).length>1||!e.match(/^\d/)||!e.match(/\d$/)):!1}function r(e){return formElems[e]&&formElems[e].value?(formElems[e].value.classList.remove("calculated"),l(formElems[e].value.value)):0}function l(e){return parseFloat((e+"").replace(/ /g,"").replace(/,/g,".")||0)}function o(e){for(var t=e.amount,a=t,n=e.payment,r=e.rate,l=r/1200,o=l+1,u=-n,i=u/(1-o),c=1,s=[];Math.round(100*a)>0;){var m=Math.pow(o,c)*(t-i)+i;c++;var d={interests:a*l,loan:n-a*l,amountAtBegin:a,loanLeft:m};a=m,s.push(d)}return s}function u(e,t){var a=document.createElement("table"),n=document.createElement("tbody");a.appendChild(n);var r=e.cloneNode(!0);return r.classList.remove("html-prototype"),n.appendChild(r),n.innerHTML=i(n.innerHTML,t),n.firstChild}function i(e,t){return e=e.replace(/\$\{\s*([\w\.]+)\s*\}/g,function(e,a){for(var n=a.split("."),r=t,l=0,o=n.length;o>l&&(r="object"==typeof t?r[n[l]]:"",""!=r);l++);return r||""})}for(var c in calculatorVariables)!function(){var o=calculatorVariables[c];formElems[o]={calc:gei(o+"-button"),value:gei(o+"-value"),minus:gei(o+"-minus"),plus:gei(o+"-plus")},formElems[o].value.setAttribute("data-placeholder",formElems[o].value.placeholder),attach(formElems[o].calc,"click",function(){var n=calculatorVariables.filter(function(e){return e!=o}),l=o;return function(){for(var o in n)calculator[n[o]]=r(n[o]);console.log(calculator);var u=calculator["calc_"+l]();calculator[l]=u;var i=formElems[l].value;console.log(u),i.value=t(e(l,u)),i.classList.add("calculated"),a()}}()),attach([formElems[o].plus,formElems[o].minus],"click",function(){var n=formElems[o].value,r=o;return function(o){var u;u=o.target.id==r+"-plus"?1:o.target.id==r+"-minus"?-1:0;var i,c;switch(r){case"duration":i=1,c=[0,+(1/0)];break;case"amount":case"payment":for(var s=1,m=l(n.value);m>100-u;s*=10,m/=10);i=s,c=[0,+(1/0)];break;case"rate":console.log(l(n.value)<1-1e-4*u,l(n.value)),i=l(n.value)>10?1:l(n.value)<1-.001*u?.01:.1,c=[0,10]}n.value=t(e(r,Math.max(c[0],Math.min(c[1],l(n.value)+i*u)).toFixed(2)-.001)),a()}}()),attach(formElems[o].value,"focus",function(){this.setCustomValidity(""),this.placeholder="",this.classList.remove("calculated")}),attach(formElems[o].value,["blur","keyup","change","input"],function(){var e=this,t=e.value.trim();!n(t)&&t.length>0?e.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable"):e.setCustomValidity(""),a()}),attach(formElems[o].value,"blur",function(){var a=this;a.placeholder=a.getAttribute("data-placeholder"),n(a.value)?a.value=t(e(o,a.value)):""==a.value?a.setCustomValidity(""):a.setCustomValidity("Cette valeur n'est pas une valeur numérique acceptable")}),attach(gei("toggle-year_month-input"),"change",function(){function e(){t.setAttribute("data-display-mode",a.checked?"monthly":"yearly")}var t=gei("depreciation_schedule"),a=gei("toggle-year_month-input");return e(),e}())}();a(),attach([].slice.call(document.querySelectorAll(".pager-button")),"click",function(){var a=document.querySelector("body");return function(){if(a.setAttribute("data-page",this.getAttribute("data-page-target")),"pager-button-1_2"==this.id){var n=calculator;setUrlHash({amount:n.amount,duration:n.duration,rate:n.rate,payment:n.payment});var r=o(n),l=new Date,i=l.getMonth(),c=l.getFullYear();console.log(i,c);for(var s={},m=0,d=r.length;d>m;m++){if(i++,i>11||m==d-1){for(var f in s[c])"undefined"==typeof s[c].loan&&(s[c].loan=0),s[c].loan+=s[c][f].loan,"undefined"==typeof s[c].interests&&(s[c].interests=0),s[c].interests+=s[c][f].interests;s[c].loanLeft=r[m==d-1?m:m-1].loanLeft}i>11&&(i=0,c++),null==s[c]&&(s[c]={}),s[c][i+1]=r[m]}for(var p=gei("depreciation_schedule"),h=p.querySelector("#depreciation_schedule-inner"),v=h.querySelector(".html-prototype"),y=h.querySelector("tr");y;){var g=y.nextElementSibling;console.log(y,y.classList),y.classList&&y.classList.contains("html-prototype")||h.removeChild(y),y=g}!function(){var a=n.payment*(12*n.duration),r=n.amount,l=a-r;p.querySelector("thead .loan-paid-graph").style.width=r/a*100+"%",p.querySelector("thead .interests-paid-graph").style.width=l/a*100+"%",p.querySelector("thead .loan-paid-value").innerHTML=t(e("payment",r))+"€",p.querySelector("thead .interests-paid-value").innerHTML=t(e("payment",l))+"€"}();for(var b=l.getFullYear(),E=0,_=0;15>_;_++){var L=b+_,C=s[L];if("undefined"!=typeof C){h.appendChild(u(v,{type:"yearly",label:L+"",loan_paid:t(e("payment",C.loan))+"€",loan_width:e("payment",C.loan)/(12*n.payment)*100+"%",interests_paid:t(e("payment",C.interests))+"€",interests_width:e("payment",C.interests)/(12*n.payment)*100+"%"}));for(var F=b==L?l.getMonth()+2:1;15>E&&12>=F;++E&&++F){var M=C[F];h.appendChild(u(v,{type:"monthly",label:("0"+F).slice(-2)+"/"+L,loan_paid:t(e("payment",M.loan))+"€",loan_width:e("payment",M.loan)/n.payment*100+"%",interests_paid:t(e("payment",M.interests))+"€",interests_width:e("payment",M.interests)/n.payment*100+"%"}))}}}}}}())}();